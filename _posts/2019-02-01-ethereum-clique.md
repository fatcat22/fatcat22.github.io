---
layout: post
title:  "ä»¥å¤ªåŠæºç è§£æï¼šå…±è¯†ç®—æ³•ä¹‹clique"
categories: ethereum
tags: åŸåˆ› ethereum consensus clique æºç è§£æ
excerpt: cliqueæ¨¡å—æ˜¯ä»¥å¤ªåŠï¼ˆethereumï¼‰ä¸­PoA(æƒå¨è¯æ˜ï¼ŒProof of Authority)å…±è¯†ç®—æ³•çš„å®ç°ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯PoAå‘¢ï¼Ÿcliqueåˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæœ¬ç¯‡æ–‡ç« å°†ä¼šç»™ä½ ç­”æ¡ˆã€‚ç›¸ä¿¡ä»”ç»†çœ‹è¿‡è¿™ç¯‡æ–‡ç« ä»¥åï¼Œä½ å°±å¯ä»¥å®ç°è‡ªå·±çš„PoAç®—æ³•äº†ã€‚
author: fatcat22
---

* content
{:toc}





# å¼•è¨€
å…±è¯†ç®—æ³•æ˜¯åŒºå—é“¾é¡¹ç›®çš„æ ¸å¿ƒä¹‹ä¸€ï¼Œæ¯ä¸€ä¸ªè¿è¡Œç€çš„åŒºå—é“¾éƒ½éœ€è¦ä¸€ä¸ªå…±è¯†ç®—æ³•æ¥ä¿è¯å‡ºå—çš„æœ‰æ•ˆæ€§å’Œæœ‰åºæ€§ã€‚åœ¨ä»¥å¤ªåŠçš„å®˜æ–¹æºç ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…±è¯†ç®—æ³•ï¼šcliqueå’Œethashï¼Œå®ƒä»¬éƒ½ä½äºä»¥å¤ªåŠé¡¹ç›®çš„consensusç›®å½•ä¸‹ã€‚cliqueç›®å½•ä¸‹çš„ä»£ç å®ç°çš„æ˜¯PoA(æƒå¨è¯æ˜ï¼ŒProof of Authority)å…±è¯†ï¼Œè¿™æ˜¯è¿™ç¯‡æ–‡ç« è¦åˆ†æçš„ä»£ç ï¼›åœ¨ethashç›®å½•ä¸‹å®ç°çš„æ˜¯PoW(å·¥ä½œé‡è¯æ˜ï¼ŒProof of Work)å…±è¯†ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šå¯¹å…¶è¿›è¡Œä»‹ç»ã€‚

å¤šæ•°åŒºå—é“¾é¡¹ç›®éƒ½ä¼šæ ¹æ®é¡¹ç›®éœ€æ±‚é€‰å®šä¸€ç§å…±è¯†ç®—æ³•ï¼Œä¸ºä»€ä¹ˆä»¥å¤ªåŠä¼šåŒæ—¶å­˜åœ¨ä¸¤ç§å‘¢ï¼Ÿè¿™èƒŒåè‚¯å®šæ˜¯æœ‰æ•…äº‹çš„ã€‚

# cliqueè¯ç”ŸèƒŒæ™¯åŠå…¶åº”ç”¨
cliqueä»£ç çš„åŸä½œè€…å¼åœ¨[è¿™é‡Œ](https://github.com/ethereum/EIPs/issues/225)å¯¹cliqueè¿›è¡Œäº†ä»‹ç»ã€‚åœ¨"Background"è¿™ä¸€èŠ‚é‡Œï¼Œä½œè€…ä¸“é—¨å¯¹è¯ç”ŸèƒŒæ™¯ä½œäº†è¯¦ç»†çš„è¯´æ˜ï¼Œå¤§ä½“æ„æ€æ˜¯è¯´æœ€å¼€å§‹å®˜æ–¹çš„testnetæ˜¯â€œMordenâ€ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»å®ƒçš„å„ç§é—ç•™é—®é¢˜å’Œå…¼å®¹é—®é¢˜è¶Šæ¥è¶Šå¤šï¼Œæ‰€ä»¥å¹²è„†æ¨å€’é‡æ¥ï¼Œåˆ›å»ºäº†æ–°çš„æµ‹è¯•ç½‘ç»œâ€œRopstenâ€ã€‚â€œRopstenâ€å’Œä¸»ç½‘ä¸€æ ·ï¼Œä½¿ç”¨çš„æ˜¯PoWå…±è¯†ç®—æ³•ã€‚ä½†åæ¥â€œRopstenâ€å—åˆ°äº†æ¶æ„æ”»å‡»ï¼Œä¸»è¦åŸå› æ˜¯å› ä¸ºPoWå…±è¯†ç®—æ³•çš„å®‰å…¨æ€§å—é™äºè®¡ç®—æœºçš„ç®—åŠ›ï¼Œè€Œâ€œRopstenâ€ä½œä¸ºæµ‹è¯•ç½‘ç»œå¯¹ç®—åŠ›çš„è¦æ±‚æ¯”è¾ƒä½ï¼Œå¯¼è‡´æ”»å‡»è€…å¯¹ç®—åŠ›çš„æ»¥ç”¨ã€‚è™½ç„¶è¿™ä»ç„¶å¯ä»¥é€šè¿‡é‡å¯æµ‹è¯•ç½‘ç»œæ¥ä¿®å¤æ”»å‡»é€ æˆçš„ä¸è‰¯å½±å“ï¼Œä½†ä»¥å¤ªåŠå›¢é˜Ÿé€‰äº†ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å°†å…±è¯†ç®—æ³•æ¢æˆPoAç±»å‹ã€‚è¿™æ‰æœ‰äº†cliqueæ¨¡å—ã€‚

ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ä»¥å¤ªåŠä¸­cliqueä»…åœ¨æµ‹è¯•ç½‘ç»œé‡Œä½¿ç”¨ï¼ŒçœŸå®çš„ä»¥å¤ªåŠä¸»ç½‘è¿˜æ˜¯ä½¿ç”¨PoWç®—æ³•ï¼ˆethashæ¨¡å—å®ç°ï¼‰ã€‚ä½†åœ¨è‡ªå·±ç»„æˆç§æœ‰ç½‘ç»œæ—¶ï¼Œä½ å¯ä»¥è‡ªç”±é€‰æ‹©ä½¿ç”¨cliqueè¿˜æ˜¯ethashã€‚


# ä»€ä¹ˆæ˜¯å…±è¯†
æœ¬ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„æ˜¯ä»‹ç»ä»¥å¤ªåŠçš„å…±è¯†ç®—æ³•ä¹‹ä¸€cliqueæ¨¡å—ï¼Œæ— æ„æ·±å…¥ä»‹ç»å…±è¯†çš„æ‰€æœ‰çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±æœç´¢ç›¸å…³çŸ¥è¯†ï¼Œæˆ–ä»¥[è¿™ç¯‡æ–‡ç« ](https://yeasy.gitbooks.io/blockchain_guide/content/distribute_system/consensus.html)ä½œä¸ºå‚è€ƒï¼Œå¯¹å…¶ä¸­ä»‹ç»åˆ°çš„çŸ¥è¯†ç‚¹è¿›è¡Œæ‹“å±•å­¦ä¹ ã€‚

åŒºå—é“¾ä¸­çš„å…±è¯†ä¸æˆ‘ä»¬æ—¥å¸¸æ‰€è¯´çš„â€œå…±è¯†â€å…¶å®æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨ç°å®ä¸–ç•Œé‡Œï¼Œæ¯ä¸ªäººä½œä¸ºç‹¬ç«‹çš„ä¸ªä½“ï¼Œå¯¹äº‹ç‰©çš„åˆ¤æ–­æ˜¯ä¸ä¸€è‡´çš„ï¼Œå„æœ‰å„çš„ä¸»è§‚æƒ³æ³•ã€‚ä½†ç¤¾ä¼šè¦æ­£å¸¸è¿è¡Œï¼Œå°±éœ€è¦æ‰€æœ‰äººå¯¹æŸäº›äº‹ç‰©æœ‰ä¸€è‡´çš„è®¤è¯†ï¼ˆæ‰€è°“è¾¾æˆå…±è¯†ï¼‰ï¼Œå¦åˆ™å°±ä¼šä¹±å¥—ã€‚æ¯”å¦‚çº¢ç»¿ç¯ï¼Œæ‰€æœ‰äººéƒ½è¦è¾¾æˆéµå®ˆçº¢ç»¿ç¯è§„åˆ™çš„å…±è¯†ï¼Œå¦åˆ™å°±ä¼šå‡ºé—®é¢˜ï¼›æ¯”å¦‚å„å›½äººæ°‘å¯¹è‡ªå·±å›½å®¶çš„è´§å¸å…¶å®éƒ½è¾¾æˆäº†å…±è¯†ï¼šè‡ªå·±å›½å®¶çš„è´§å¸æ˜¯æœ‰è´­ä¹°åŠ›çš„ï¼ˆå…¨ä¸–ç•Œçš„äººéƒ½å¯ä»¥ç”¨ç¾å…ƒäº¤æ˜“ï¼Œæ˜¯å› ä¸ºå…¨ä¸–ç•Œçš„äººéƒ½å¯¹â€œç¾å…ƒå…·æœ‰è´­ä¹°åŠ›â€è¾¾æˆäº†å…±è¯†ï¼‰ï¼›å†æ¯”å¦‚æ¶ˆè´¹ï¼Œä¹°ä¸œè¥¿è¦ä»˜é’±ï¼Œè¿™æ˜¯æ‰€æœ‰äººå¿…é¡»è¾¾æˆä¸€è‡´çš„ï¼Œå¦‚æœæœ‰ä¸€å¸®äººè®¤ä¸ºä¹°ä¸œè¥¿è¦ä»˜é’±ã€å¦ä¸€å¸®äººè®¤ä¸ºä¹°ä¸œè¥¿ç»™å—çŸ³å¤´å°±è¡Œäº†ï¼Œé‚£å°±ä¼šå‡ºç°æ··ä¹±ï¼ˆä¸€ä¸ªäººåšå‡ºçš„å†³å®šï¼Œå¦ä¸€ä¸ªäººä¸è®¤å¯ï¼‰ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå…±è¯†å…¶å®æ˜¯ä¸€ä¸ªå¾ˆåŸºæœ¬çš„æ¦‚å¿µï¼Œå¹¿æ³›å­˜åœ¨äºå„ä¸ªæ–¹é¢ï¼Œè¿™ä¸€ç‚¹ä»[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Consensus_(disambiguation))ä¸Šå¯¹â€œå…±è¯†â€çš„è§£é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ã€‚æˆ‘ä»¬å¸¸è¯´çš„â€œåšäººè¦è®²é“ç†â€ä¸­çš„é“ç†å³æ˜¯å…±è¯†ï¼ˆæ‰€è°“çš„é“ç†æ˜¯æ¯ä¸ªäººéƒ½è®¤å¯çš„åŸºæœ¬è§‚ç‚¹ï¼Œæ¯”å¦‚è¦å­é¡ºã€è¦æœ‰ç¤¼è²Œï¼Œå¦‚æœæ¯ä¸ªäººå¿ƒä¸­éƒ½æœ‰è‡ªå·±ä¸åŒçš„ä¸€å¥—é“ç†ï¼Œé‚£è·Ÿæ²¡é“ç†æ˜¯ä¸€æ ·çš„ï¼‰ã€‚åœ¨è®¡ç®—æœºä¸­ï¼Œå…±è¯†æœ€æ—©æ˜¯åˆ†å¸ƒå¼è®¡ç®—çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè€ŒåŒºå—é“¾çš„ä¸–ç•Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ä¸–ç•Œã€‚

åœ¨åŒºå—é“¾ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹å’Œæ¯ä¸ªäººç±»ä¼¼ï¼Œéƒ½æ˜¯ç‹¬ç«‹çš„ä¸ªä½“ã€‚è¿™äº›ç‹¬ç«‹çš„èŠ‚ç‚¹æƒ³è¦é¡ºåˆ©åœ°å…±åŒå®Œæˆä¸€ä»¶äº‹æƒ…ï¼ˆæ¯”å¦‚å‡ºå—ã€è®°è´¦ï¼Œå¯¹é“¾è¿›è¡Œç»´æŠ¤ï¼‰ï¼Œå°±éœ€è¦éµå®ˆç›¸åŒçš„åŸºæœ¬è§„åˆ™ï¼Œå¦åˆ™ä¸€ä¸ªèŠ‚ç‚¹äº§ç”Ÿçš„æ•°æ®ï¼Œåˆ«çš„èŠ‚ç‚¹ä¹Ÿä¸ä¼šè®¤å¯ã€‚è¿™äº›åŸºæœ¬è§„åˆ™ï¼Œæ¯”å¦‚ä¸€ä¸ªæ­£å¸¸çš„å—æœ‰å“ªäº›é™åˆ¶ã€é“¾æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå—çš„æ­£ç¡®æ€§ç­‰ç­‰è¿™äº›ï¼Œå…±åŒç»„æˆäº†å…±è¯†ã€‚

ä¸Šé¢è¿™äº›æ˜¯æˆ‘è‡ªå·±çš„ç†è§£ï¼Œä¸ºäº†å‡†ç¡®æ€§ï¼Œæˆ‘è¿™é‡Œæ‘˜å½•äº†[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/%E5%85%B1%E8%AD%98%E6%A9%9F%E5%88%B6)ä¸­å¯¹å…±è¯†çš„è§£é‡Šï¼Œæ¥ç»“æŸæˆ‘ä»¬å¯¹å…±è¯†çš„è®¨è®ºï¼š
>ç”±äºåŠ å¯†è´§å¸å¤šæ•°é‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„åŒºå—é“¾è®¾è®¡ï¼ŒèŠ‚ç‚¹æ˜¯å„å¤„åˆ†æ•£ä¸”å¹³è¡Œçš„ï¼Œæ‰€ä»¥å¿…é¡»è®¾è®¡ä¸€å¥—åˆ¶åº¦ï¼Œæ¥ç»´æŠ¤ç³»ç»Ÿçš„è¿ä½œé¡ºåºä¸å…¬å¹³æ€§ï¼Œç»Ÿä¸€åŒºå—é“¾çš„ç‰ˆæœ¬ï¼Œå¹¶å¥–åŠ±æä¾›èµ„æºç»´æŠ¤åŒºå—é“¾çš„ä½¿ç”¨è€…ï¼Œä»¥åŠæƒ©ç½šæ¶æ„çš„å±å®³è€…ã€‚è¿™æ ·çš„åˆ¶åº¦ï¼Œå¿…é¡»ä¾èµ–æŸç§æ–¹å¼æ¥è¯æ˜ï¼Œæ˜¯ç”±è°å–å¾—äº†ä¸€ä¸ªåŒºå—é“¾çš„æ‰“åŒ…æƒï¼ˆæˆ–ç§°è®°è´¦æƒï¼‰ï¼Œå¹¶ä¸”å¯ä»¥è·å–æ‰“åŒ…è¿™ä¸€ä¸ªåŒºå—çš„å¥–åŠ±ï¼›åˆæˆ–è€…æ˜¯è°æ„å›¾è¿›è¡Œå±å®³ï¼Œå°±ä¼šè·å¾—ä¸€å®šçš„æƒ©ç½šï¼Œè¿™å°±æ˜¯å…±è¯†æœºåˆ¶ã€‚


# ä»€ä¹ˆæ˜¯PoA
PoAæ˜¯å…±è¯†ç®—æ³•çš„ä¸€ç§ï¼Œå®ƒçš„å…¨ç§°ä¸ºProof of Authorityï¼Œä¸­æ–‡è¯‘ä¸ºå¨æƒè¯æ˜ã€‚PoAçš„åŸºæœ¬æ€æƒ³åº”è¯¥ä¹Ÿæ˜¯æ¥æºäºç°å®ä¸–ç•Œï¼šåœ¨ç°å®ä¸–ç•Œé‡Œï¼Œå¯¹å¾ˆå¤šäº‹æƒ…æˆ‘ä»¬å¾€å¾€â€œè¯‰è¯¸æƒå¨â€ï¼Œå³æˆ‘ä»¬ç›¸ä¿¡ä¸“å®¶ã€‚PoAçš„æ€æƒ³ä¸æ­¤ç±»ä¼¼ï¼šæˆæƒä¸€å®šæ•°é‡çš„â€œä¸“å®¶â€ï¼Œç”±è¿™äº›äººç›¸äº’åˆä½œæ‰“åŒ…åŒºå—å¹¶å¯¹åŒºå—é“¾è¿›è¡Œç»´æŠ¤ï¼Œå…¶å®ƒäººåˆ™æ— æƒæ‰“åŒ…åŒºå—ï¼Œå¹¶ä¸”æ™®é€šäººç›¸ä¿¡æˆä¸ºä¸“å®¶çš„äººä¼šåŠªåŠ›ç»´æŠ¤åŒºå—é“¾çš„æ­£å¸¸ç§©åºã€‚

å½“ç„¶äº‹æƒ…æ²¡è¿™ä¹ˆç®€å•ï¼Œä¸æ˜¯è¯´æˆ‘ä»¬æƒ³å½“ç„¶çš„è®¤ä¸ºè°æ˜¯ä¸“å®¶ä»–å°±æ˜¯äº†ã€‚ä¸“å®¶éœ€è¦å…¬å¼€è‡ªå·±çš„èº«ä»½ã€‚è¿™ä¹Ÿæ˜¯PoAè®¾è®¡åˆè¡·çš„ä¸€éƒ¨åˆ†ï¼šè®¾è®¡è€…è®¤ä¸ºæ¯ä¸ªäººéƒ½æ˜¯çˆ±æƒœè‡ªå·±çš„å£°èª‰çš„ï¼Œé€šè¿‡å…¬å¼€è‡ªå·±èº«ä»½ï¼Œä¸“å®¶ä¼šä¸ºäº†è‡ªå·±çš„å£°èª‰åŠªåŠ›åšæ­£ç¡®çš„äº‹ï¼Œè€Œä¸æ˜¯ä½œæ¶ã€‚

æ€»å¾—æ¥è¯´PoAå…±è¯†ä¸­å‡ºå—æƒæŒæ¡åœ¨éƒ¨åˆ†ä¸“å®¶æ‰‹é‡Œï¼Œè€Œæ™®é€šäººæ˜¯æ— æ³•å‚ä¸çš„ï¼ˆæ— è®ºä½ æœ‰å¤šå°‘ç®—åŠ›ã€å¤šå°‘æƒç›Šï¼‰ã€‚å¯è§PoAå…±è¯†ç‰ºç‰²äº†ä¸€éƒ¨å»ä¸­å¿ƒåŒ–çš„ç‰¹æ€§ï¼Œæ¢æ¥äº†ä¸€ç§å¯æ§æ€§ã€‚ä½†å®ƒåŒæ—¶æœ‰ä¸¤ä¸ªé—®é¢˜æ˜¯å¿…é¡»è§£å†³çš„ï¼Œæˆ‘ä»¬é€ä¸ªä»‹ç»ã€‚

æ³¨æ„ï¼Œåœ¨åé¢çš„æ–‡ç« é‡Œï¼Œä¸ºäº†æè¿°çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†ä¸“å®¶ç§°ä¸ºâ€œç­¾åè€…â€ï¼Œå³æœ‰æƒç”Ÿæˆæ–°åŒºå—å¹¶ç­¾åçš„è´¦å·åœ°å€ã€‚

- **é—®é¢˜1ï¼šå¦‚ä½•å®ç°ç­¾åè€…çš„å¼•è¿›å’Œè¸¢å‡º**  
PoAçš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯éœ€è¦è§£å†³ç­¾åè€…æ›´æ¢çš„é—®é¢˜ã€‚åœ¨PoAä¸­ï¼Œç­¾åè€…å¿…é¡»ä¿è¯å¤šæ•°æƒ…å†µä¸‹åœ¨çº¿å‡ºå—ã€‚ç„¶è€Œéšç€é¡¹ç›®çš„ä¸æ–­è¿è¡Œï¼Œä¸å¯èƒ½æ‰€æœ‰ç­¾åè€…éƒ½ä¸€ç›´æœ‰èµ„æºã€æœ‰æ„æ„¿ç»§ç»­å·¥ä½œï¼›å¦å¤–å¶å°”ç­¾åè€…ä¹Ÿä¼šä½œæ¶ï¼Œå¿…é¡»åŠæ—¶å°†ä½œæ¶çš„äººè¸¢å‡ºã€‚ï¼ˆä½œä¸ºå¯¹æ¯”ï¼Œåœ¨PoW(å·¥ä½œé‡è¯æ˜)ä¸­ï¼Œä»»ä½•ä¸€ä¸ªäººéƒ½å¯ä»¥éšæ—¶æ¥å…¥åŒºå—é“¾ç½‘ç»œå¹¶å°è¯•å‡ºå—ï¼Œä¹Ÿå¯ä»¥éšæ—¶é€€å‡ºç½‘ç»œï¼‰
- **é—®é¢˜2ï¼šå¦‚ä½•æ§åˆ¶å‡ºå—æ—¶æœº**  
é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯ï¼Œå‡ºå—æ—¶æœºç”±ä¸¤æ–¹é¢å†³å®šï¼šä¸€æ˜¯å‡ºå—æ—¶é—´ï¼›äºŒæ˜¯ç”±è°å‡ºå—ã€‚åœ¨PoAä¸­ï¼Œç­¾åè€…ä¹‹é—´æ˜¯åˆä½œå…³ç³»ï¼Œå¤§å®¶â€œå’Œå’Œæ°”æ°”â€ï¼Œä»€ä¹ˆæ—¶é—´å‡ºå—ã€ç”±è°å‡ºéƒ½è¦æŒ‰è§„åˆ™æ¥ï¼Œä¸èƒ½äº‰ä¸èƒ½æŠ¢ã€‚å› æ­¤éœ€è¦æœ‰è‰¯å¥½çš„è§„åˆ™æ§åˆ¶å‡ºå—æ—¶æœºã€‚ï¼ˆä½œä¸ºå¯¹æ¯”ï¼Œåœ¨PoWä¸­ï¼Œå‡ºå—æ—¶é—´æ ¹æ®å†å²å‡ºå—è®°å½•åŠ¨æ€è°ƒæ•´ï¼›ç”±è°å‡ºå—æ˜¯ç”±ç®—åŠ›å†³å®šçš„ï¼šç®—åŠ›è¶Šå¼ºï¼Œè¶Šèƒ½è·å¾—å‡ºå—æƒã€‚å¯è§åœ¨PoWä¸­ç­¾åè€…ä¹‹é—´æ˜¯ç«äº‰çš„å…³ç³»ï¼Œå‡ºå—æ—¶æœºç”±èƒ½åŠ›ç¡®å®šï¼‰

æˆ‘è®¤ä¸ºä¸€ä¸ªå¥½çš„PoAå®ç°ï¼Œå¿…é¡»è¦è§£å†³å¥½è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹cliqueæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚


# cliqueçš„è®¾è®¡æ¦‚è¦
cliqueæ¨¡å—çš„åŸä½œè€…åœ¨[è¿™ç¯‡æ–‡ç« ](https://github.com/ethereum/EIPs/issues/225)é‡Œè¯¦ç»†è¯´æ˜äº†cliqueçš„è®¾è®¡å’ŒèƒŒæ™¯ã€‚cliqueä½œä¸ºPoAçš„ä¸€ä¸ªå®ç°ï¼Œè‡ªç„¶è¦è§£å†³å‰é¢æåˆ°çš„ä¸¤ä¸ªé—®é¢˜ã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬ä»è¿™ä¸¤ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„è§’åº¦ï¼Œæ±‡æ€»ä¸€ä¸‹ä½œè€…å¯¹cliqueçš„è®¾è®¡ã€‚

ä¸ºäº†è¡¨è¾¾æ¸…æ™°ï¼Œæˆ‘ä»¬éœ€è¦æå…ˆè¯´æ˜å‡ ä¸ªåŸæ–‡ä¸­çš„æ•°æ®å’Œåè¯çš„å®šä¹‰ï¼š
- **checkpoint**: ä¸€ä¸ªç‰¹æ®Šçš„blockï¼Œå®ƒçš„é«˜åº¦æ˜¯EPOCH_LENGTHçš„æ•´æ•°å€ï¼Œblockä¸­ä¸åŒ…å«æŠ•ç¥¨ä¿¡æ¯ä½†åŒ…å«å½“æ—¶æ‰€æœ‰çš„ç­¾åè€…åˆ—è¡¨
- **SIGNER_COUNT**: æŸä¸€æ—¶åˆ»ç­¾åè€…çš„æ•°é‡
- **SIGNER_LIMIT**: è¿ç»­çš„å—çš„æ•°é‡ï¼Œåœ¨è¿™äº›è¿ç»­çš„å—ä¸­ï¼ŒæŸä¸€ç­¾åè€…æœ€å¤šåªèƒ½ç­¾ä¸€ä¸ªå—ï¼›åŒæ—¶ä¹Ÿæ˜¯æŠ•ç¥¨ç”Ÿæ•ˆçš„ç¥¨æ•°çš„æœ€å°å€¼
- **BLOCK_PERIOD**: ä¸¤ä¸ªç›¸é‚»çš„å—çš„Timeå­—æ®µçš„æœ€å°å·®å€¼ï¼Œä¹Ÿæ˜¯å‡ºå—å‘¨æœŸ
- **EPOCH_LENGTH**: ä¸¤ä¸ªcheckpointä¹‹é—´çš„blockçš„æ•°é‡ã€‚è¾¾åˆ°è¿™ä¸ªæ•°é‡åä¼šç”Ÿæˆcheckpointä»¥åŠæ¸…é™¤å½“å‰æ‰€æœ‰æœªç”Ÿæ•ˆçš„æŠ•ç¥¨ä¿¡æ¯
- **DIFF_INTURN**: å‡ºå—çŠ¶æ€ï¼ˆdifficultyï¼‰ä¹‹ä¸€ï¼Œæ­¤çŠ¶æ€ä»£è¡¨â€œæŒ‰é“ç†å·²ç»è½®åˆ°æˆ‘å‡ºå—â€
- **DIFF_NOTURN**: å‡ºå—çŠ¶æ€ï¼ˆdifficultyï¼‰ä¹‹ä¸€ï¼Œæ­¤çŠ¶æ€ä»£è¡¨â€œæŒ‰é“ç†è¿˜æ²¡è½®åˆ°æˆ‘å‡ºå—â€

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹cliqueæ˜¯å¦‚ä½•è§£å†³ä¸Šä¸€èŠ‚æåˆ°çš„ä¸¤ä¸ªé—®é¢˜çš„ã€‚

- **é—®é¢˜1ï¼šå¦‚ä½•å®ç°ç­¾åè€…çš„å¼•è¿›å’Œè¸¢å‡º**  
cliqueä¸­ç­¾åè€…çš„å¼•è¿›å’Œè¸¢å‡ºæ˜¯é€šè¿‡å·²æœ‰ç­¾åè€…è¿›è¡ŒæŠ•ç¥¨å®ç°çš„ï¼Œå¹¶ä¸”åŠ å…¥äº†æ›´åŠ è¯¦ç»†çš„æ§åˆ¶ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹cliqueä¸­çš„æŠ•ç¥¨è§„åˆ™ï¼š
  - æŠ•ç¥¨ä¿¡æ¯ä¿å­˜åœ¨blockä¸­ã€‚ä¸€ä¸ªblockåªæœ‰ä¸€ä¸ªæŠ•ç¥¨ä¿¡æ¯ï¼Œä¸”åªèƒ½åœ¨è‡ªå·±ç”Ÿæˆçš„blockä¸Šä¿å­˜ã€‚
  - é’ˆå¯¹æŸä¸ªè¢«æŠ•äººçš„ç¥¨æ•°è¶…è¿‡SIGNER_LIMITæ—¶ï¼ŒæŠ•ç¥¨ç»“æœç«‹å³ç”Ÿæ•ˆã€‚
  - æŠ•ç¥¨ç”Ÿæ•ˆåï¼Œç«‹å³æ¸…é™¤æ‰€æœ‰è¢«æŠ•äººæ˜¯å½“å‰ç”Ÿæ•ˆäººçš„æŠ•ç¥¨ä¿¡æ¯ã€‚å¦‚æœæŠ•çš„æ˜¯è¸¢å‡ºç¥¨ï¼Œåˆ™è¢«æŠ•äººä¹‹å‰æŠ•å‡ºçš„ã€ä½†è¿˜æœªç”Ÿæ•ˆçš„æŠ•ç¥¨å…¨éƒ¨å¤±æ•ˆã€‚
  - è¸¢å‡ºä¸€ä¸ªç­¾åè€…ä»¥åï¼Œå¯èƒ½ä¼šå¯¼è‡´åŸæ¥ä¸é€šè¿‡çš„æŠ•ç¥¨ç†è®ºä¸Šå¯ä»¥é€šè¿‡ã€‚cliqueä¸ç‰¹æ„å¤„ç†è¿™ç§æƒ…å†µï¼Œç­‰å¾…ä¸‹æ¬¡ç»Ÿè®¡æ—¶å†åˆ¤æ–­ã€‚
  - å‘èµ·ä¸€ä¸ªæŠ•ç¥¨åï¼Œå®¢æˆ·ç«¯ä¸ä¼šè¢«ç«‹å³æ¸…é™¤æŠ•ç¥¨ä¿¡æ¯ï¼Œè€Œæ˜¯åœ¨ä¹‹åæ¯æ¬¡å‡ºå—æ—¶éƒ½ä¼šé€‰ä¸€ä¸ªç»§ç»­æŠ•ç¥¨ã€‚å› ä¸ºåŒºå—é“¾ä¸­çš„æœ‰æ•ˆåŒºå—æœ‰é‡æ–°è°ƒæ•´çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥ä¸èƒ½è®¤ä¸ºæŠ•ç¥¨ç”Ÿæ•ˆäº†ä¹‹åå°±ä¼šä¸€ç›´ç”Ÿæ•ˆã€‚
  - æ— æ•ˆçš„æŠ•ç¥¨ï¼šè¢«æŠ•ç¥¨äººä¸åœ¨å½“å‰ç­¾åè€…åˆ—è¡¨ä¸­ä½†æŠ•çš„æ˜¯è¸¢å‡ºç¥¨ï¼Œæˆ–è¢«æŠ•ç¥¨äººåœ¨å½“å‰ç­¾ååˆ—è¡¨ä¸­ä½†æŠ•çš„æ˜¯å¼•è¿›ç¥¨
  - ä¸ºäº†ä½¿ç¼–ç ç®€å•ï¼Œæ— æ•ˆçš„æŠ•ç¥¨ä¸ä¼šå—åˆ°æƒ©ç½šï¼ˆå…¶å®æˆ‘è®¤ä¸ºæœ‰äº›åŠŸèƒ½å®ç°ä¹Ÿä¾èµ–äºæ— æ•ˆçš„æŠ•ç¥¨ï¼‰
  - åœ¨æ¯ä¸ªEPOCH_LENGTHå†…ï¼Œä¸€ä¸ªç­¾åè€…ç»™åŒä¸€ä¸ªè´¦å·åœ°å€é‡å¤æŠ•ç¥¨æ—¶ï¼Œä¼šå…ˆå°†ä¸Šæ¬¡çš„æŠ•ç¥¨ä¿¡æ¯æ¸…é™¤ï¼Œç„¶åå†ç»Ÿè®¡æœ¬æ¬¡çš„æŠ•ç¥¨ä¿¡æ¯ï¼ˆå¦‚æœæœ¬æ¬¡ä¸ºæ— æ•ˆçš„æŠ•ç¥¨ä¸ä¼šæ¢å¤å·²ç»æ¸…é™¤çš„ä¸Šæ¬¡æŠ•ç¥¨ä¿¡æ¯ï¼‰
  - æ¯ä¸ªcheckpointä¸è¿›è¡ŒæŠ•ç¥¨ï¼Œè€Œåªæ˜¯åŒ…å«å½“å‰ç­¾åè€…åˆ—è¡¨ä¿¡æ¯ã€‚å¯¹äºå…¶å®ƒåŒºå—ï¼Œå¯ä»¥ç”¨æ¥æºå¸¦æŠ•ç¥¨ä¿¡æ¯ã€‚

å…³äºä¸Šé¢é‡å¤æŠ•ç¥¨çš„å¤„ç†éœ€è¦å¤šè¯´ä¸€ä¸‹ï¼Œè¿™ç§å¤„ç†æ–¹å¼ä¼šäº§ç”Ÿä¸¤ä¸ªç»“æœï¼ˆå‡è®¾æŠ•ç¥¨äººæ˜¯Aï¼Œè¢«æŠ•ç¥¨äººæ˜¯Bï¼‰ï¼š
1. åœ¨å½“å‰EPOCH_LENGTHå†…ï¼ŒAç»™Båªèƒ½æŠ•ä¸€ç¥¨
2. åœ¨å½“å‰EPOCH_LENGTHå†…ï¼Œå¦‚æœç»™Bçš„æŠ•ç¥¨æœªç”Ÿæ•ˆï¼ˆæ€»ç¥¨æ•°æœªè¶…è¿‡SIGNER_LIMITï¼‰æ—¶Aæƒ³æŠŠæŠ•ç»™Bçš„ç¥¨æ’¤æ¶ˆï¼Œé‚£ä¹ˆAå¯ä»¥æŠ•ä¸€æ¬¡è·Ÿä¹‹å‰ç›¸åçš„ç¥¨ã€‚å› ä¸ºæ–°çš„æŠ•ç¥¨ä¼šå¯¼è‡´æ—§çš„æŠ•ç¥¨ä¿¡æ¯æ¸…é™¤ï¼Œè€Œå¦‚æœæ—§çš„æŠ•ç¥¨æ˜¯æœ‰æ•ˆçš„åˆ™æ–°çš„æŠ•ç¥¨å¿…å®šæ˜¯æ— æ•ˆçš„ï¼Œå› è€Œä¹Ÿä¸ä¼šè¿›å…¥æŠ•ç¥¨ç»Ÿè®¡ã€‚

- **é—®é¢˜2ï¼šå¦‚ä½•æ§åˆ¶å‡ºå—æ—¶æœº**  
å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå‡ºå—æ—¶æœºç”±ä¸¤æ–¹é¢å†³å®šï¼šä¸€æ˜¯å‡ºå—æ—¶é—´ï¼›äºŒæ˜¯ç”±è°å‡ºå—ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹cliqueæ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚
  - å‡ºå—æ—¶é—´  
  åœ¨cliqueä¸­ï¼Œå‡ºå—æ—¶é—´æ˜¯å›ºå®šçš„ï¼Œç”±BLOCK_PERIODå†³å®šã€‚
  - ç”±è°å‡ºå—  
  cliqueä¸­å‡ºå—æƒçš„ç¡®å®šç¨å¾®å¤æ‚ï¼Œå…·ä½“è§„åˆ™ä¸ºï¼š  
    - ç­¾åè€…åœ¨ç­¾åè€…åˆ—è¡¨ä¸­ä¸”åœ¨SIGNER_LIMITå†…æ²¡å‡ºè¿‡å—
    - å¦‚æœç­¾åè€…æ˜¯DIFF_INTURNçŠ¶æ€ï¼Œåˆ™æ‹¥æœ‰è¾ƒé«˜å‡ºå—æƒï¼ˆç­‰å¾…å‡ºå—æ—¶é—´åˆ°æ¥ï¼Œç­¾ååŒºå—å¹¶ç«‹å³å¹¿æ’­å‡ºå»ï¼‰
    - å¦‚æœç­¾åè€…æ˜¯DIFF_NOTURNçŠ¶æ€ï¼Œåˆ™æ‹¥æœ‰è¾ƒä½å‡ºå—æƒï¼ˆç­‰å¾…å‡ºå—æ—¶é—´åˆ°æ¥ï¼Œå†å»¶è¿Ÿä¸€ä¸‹ï¼ˆå»¶è¿Ÿæ—¶é—´ä¸ºrand(SIGNER_COUNT * 500ms)ï¼‰  

å¯è§å‡ºå—æƒç”±ä¸¤æ–¹é¢ç¡®å®šï¼šä¸€æ˜¯æœ€è¿‘æ˜¯å¦å‡ºè¿‡å—ï¼Œå¦‚æœå‡ºè¿‡åˆ™æ²¡æœ‰å‡ºå—æƒï¼›äºŒæ˜¯DIFF_INTURN / DIFF_NOTURNçŠ¶æ€ï¼ŒDIFF_INTURNæ‹¥æœ‰è¾ƒé«˜å‡ºå—æƒã€‚

ä»¥ä¸Šæ˜¯æˆ‘ä»¬å¯¹cliqueä¸­å®ç°PoAå…³é”®ç‚¹çš„è§„åˆ™è¯´æ˜ï¼Œå¦‚æœç›®å‰çœ‹ä¸å¤ªæ‡‚ä¹Ÿæ²¡å…³ç³»ï¼Œåé¢è¿˜ä¼šæœ‰é’ˆå¯¹æ€§çš„åˆ†æè¯´æ˜ã€‚ç›¸ä¿¡ç†è§£è¿™äº›è§„åˆ™ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªPoAå…±è¯†ç®—æ³•äº†ã€‚


# ä½¿ç”¨cliqueæ­å»ºç§æœ‰ç½‘ç»œè¿›è¡Œè°ƒè¯•
ä½¿ç”¨ä»¥å¤ªåŠæ­å»ºç§æœ‰ç½‘ç»œæœ¬æ¥ä¸è¿™ç¯‡æ–‡ç« çš„å†…å®¹æ²¡æœ‰å…³ç³»ï¼Œä½†æˆ‘è‡ªå·±åœ¨å­¦ä¹ æºä»£ç çš„è¿‡ç¨‹ä¸­æ„Ÿè§‰åªè¯»ä»£ç æœ‰äº›éš¾ä»¥ç†è§£ï¼Œå› æ­¤æ­å»ºäº†ä¸€ä¸ªç®€å•çš„æœ‰ä¸‰ä¸ªèŠ‚ç‚¹çš„ç§æœ‰ç½‘ç»œï¼Œå¹¶ä½¿ç”¨cliqueä½œä¸ºå…±è¯†æ¨¡å—ï¼Œé€šè¿‡ç¨‹åºçš„å®é™…è¿è¡ŒåŠ æ·±å’ŒéªŒè¯æˆ‘å¯¹ä»£ç çš„ç†è§£ã€‚æˆ‘è§‰å¾—ä½œä¸ºè¯»è€…çš„ä½ å¯èƒ½ä¹Ÿä¼šéœ€è¦ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†æ­å»ºçš„è¿‡ç¨‹ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚

æ³¨æ„æˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶ä½¿ç”¨çš„æ˜¯[go-ethereum](https://github.com/ethereum/go-ethereum)é¡¹ç›®ä¸Šçš„masteråˆ†æ”¯ï¼Œcommit id ä¸º257bfff316e4efb8952fbeb67c91f86af579cb0aã€‚

> 1. æ‰§è¡Œ`make all`è¿›è¡Œç¼–è¯‘ã€‚ç¼–è¯‘ç»“æœåœ¨build/binç›®å½•ä¸‹ã€‚è¿™æ—¶æˆ‘ä»¬åªç”¨åˆ°åˆ°gethå’Œpuppethä¸¤ä¸ªç¨‹åºã€‚
> 2. è¿›å…¥build/binç›®å½•ã€‚ï¼ˆåé¢ä¼šåœ¨è¿™ä¸ªç›®å½•ä¸‹ç”Ÿæˆä¸€äº›æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚è¿™é‡Œæˆ‘ä¸ºäº†è¿è¡Œgethå’Œpuppehç¨‹åºæ–¹ä¾¿ç›´æ¥åœ¨build/binç›®å½•ä¸‹æ“ä½œï¼Œä½ ä¹Ÿå¯ä»¥æ¢æˆå…¶å®ƒç›®å½•ï¼‰
> 3. åœ¨å½“å‰ç›®å½•åˆ›å»ºnode0ã€node1ã€node2ä¸‰ä¸ªæ–‡ä»¶å¤¹ã€‚
> 4. è°ƒç”¨`geth --datadir node0 account new`åœ¨node0ç›®å½•ä¸‹åˆ›å»ºæ–°çš„è´¦å·ã€‚ä½¿ç”¨ç±»ä¼¼çš„å‘½ä»¤ä¸ºnode1ã€node2åˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œä¸ºäº†æ–¹ä¾¿ä¸‰ä¸ªè´¦å·çš„å¯†ç æœ€å¥½éƒ½è®¾ç½®æˆä¸€æ ·çš„ï¼Œå¹¶ä¿å­˜åœ¨./passwordæ–‡ä»¶ä¸­ã€‚è®°ä½è¿™ä¸‰ä¸ªè´¦å·ï¼Œä¸‹ä¸€æ­¥ä¼šç”¨åˆ°ã€‚
> 5. ä½¿ç”¨puppethç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚puppethæ˜¯äº¤äº’å¼çš„ï¼Œä½ å¯ä»¥è·Ÿæ®æç¤ºè¿›è¡Œæ“ä½œï¼Œè¿‡ç¨‹ä¸­ä¼šç”¨åˆ°ä¸Šä¸€æ­¥ç”Ÿæˆçš„è´¦å·ä½œä¸º"allowed to seal"çš„è´¦å·ã€‚åœ¨é€‰æ‹©"consensus engine"æ—¶è®°å¾—ä½¿ç”¨cliqueã€‚ï¼ˆå‡è®¾æœ€åç”Ÿæˆçš„æ–‡ä»¶ä¸ºå½“å‰ç›®å½•çš„genesis.jsonï¼‰
> 6. puppethç”Ÿæˆçš„é…ç½®æ–‡ä»¶æ˜¯jsonæ ¼å¼ï¼Œä½†æ— æ³•ç›´æ¥ç”¨äºgethï¼Œéœ€è¦å»æ‰å…¶å®ƒå­—æ®µï¼Œè€ŒæŠŠ"genesis"å­—æ®µçš„å†…å®¹ä½œä¸ºæ•´ä¸ªjsonæ–‡ä»¶çš„å†…å®¹ã€‚
> 7. ä½¿ç”¨`geth --datadir node0 init genesis.json`åˆå§‹åŒ–èŠ‚ç‚¹æ•°æ®ï¼Œä½¿ç”¨ç±»ä¼¼çš„å‘½ä»¤åˆå§‹åŒ–node1å’Œnode2ç›®å½•ã€‚
> 8. ä½¿ç”¨`geth --datadir node0 --port 30000 --nodiscover --unlock '0' --password ./password console`å¯åŠ¨èŠ‚ç‚¹ã€‚æ–°æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ï¼Œå¹¶ä½¿ç”¨ç±»ä¼¼çš„å‘½ä»¤å¯åŠ¨å…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹ï¼ˆæ³¨æ„ä¿®æ”¹datadirå’Œportå‚æ•°ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¸ç›¸åŒï¼‰ã€‚æ³¨æ„ä½¿ç”¨consoleå‚æ•°åï¼Œå¯ä»¥é€šè¿‡ä»¥å¤ªåŠçš„æ§åˆ¶å°å¯¹èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚
> 9. åœ¨æ¯ä¸ªèŠ‚ç‚¹å¯åŠ¨åçš„logä¸­ï¼Œæœ‰ä¸€æ¡â€œStarted P2P networkingâ€çš„logï¼Œå…¶selfå‚æ•°æ˜¯å½“å‰èŠ‚ç‚¹çš„p2påœ°å€ã€‚åœ¨consoleä¸­ï¼Œä½¿ç”¨å‘½ä»¤`admin.addPeer("nodeAddr")`æ·»åŠ èŠ‚ç‚¹ï¼Œå…¶ä¸­nodeAddrå‚æ•°ä¸ºèŠ‚ç‚¹p2påœ°å€ã€‚ä¸ºnode0æ·»åŠ node1å’Œnode2çš„åœ°å€ï¼Œä¸ºnode1æ·»åŠ node2çš„åœ°å€ã€‚
> 10. è‡³æ­¤ï¼Œè¿™ä¸‰ä¸ªèŠ‚ç‚¹å·²ç»ç›¸äº’å‘ç°ï¼Œç»„æˆäº†ä¸€ä¸ªç§æœ‰ç½‘ç»œã€‚åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„consoleä¸­è°ƒç”¨`miner.start()`ä½¿å½“å‰èŠ‚ç‚¹å¼€å§‹å‡ºå—ã€‚


# ä»£ç åˆ†æ
åœ¨è¿™ä¸€å°èŠ‚é‡Œï¼Œæˆ‘ä»¬å°†å¯¹cliqueæ¨¡å—çš„é‡è¦ä»£ç è¿›è¡Œè¯¦ç»†çš„åˆ†æå’Œè¯´æ˜ã€‚æˆ‘ä»¬é¦–å…ˆä»ç»†èŠ‚ç€æ‰‹ï¼Œå¯¹ä¸€äº›ä»£ç å®ç°ä¸­çš„æ¦‚å¿µè¿›è¡Œè¯´æ˜ï¼›ç„¶åä»ä¸€ä¸ªå…¨å±€çš„è§†è§’ï¼Œçœ‹ä¸€çœ‹cliqueæ˜¯å¦‚ä½•é…åˆæŒ–çŸ¿æ¨¡å—è¿›è¡ŒæŒ–çŸ¿çš„ã€‚


### Headerå­—æ®µæ„ä¹‰å˜åŒ–
åœ¨ä»¥å¤ªåŠä¸­å­˜åœ¨ä¸¤ç§å…±è¯†ï¼Œä½†æ˜¾ç„¶ä¸èƒ½ç”¨ä¸¤å¥—åŒºå—é“¾ä¸Šçš„æ•°æ®ç»“æ„ã€‚å› æ­¤ä½œä¸ºåæ¥å®ç°çš„cliqueåªèƒ½å¤ç”¨åŸæ¥Headerçš„å­—æ®µã€‚ä¸‹é¢æˆ‘ä»¬å¯¹è¿™äº›å¤ç”¨çš„å­—æ®µä¸€ä¸€è¯´æ˜ä¸€ä¸‹ã€‚

- Header.Coinbase  
Coinbaseå­—æ®µåœ¨ethashä¸­ç”¨æ¥å­˜æ”¾å‡ºå—è€…çš„åœ°å€ã€‚åœ¨cliqueä¸­ç”¨æ¥ä¿å­˜æŠ•ç¥¨æ—¶è¢«æŠ•ç¥¨äººçš„åœ°å€ã€‚è€Œå‡ºå—è€…çš„åœ°å€é€šè¿‡ç­¾åæ•°æ®è®¡ç®—å¾—å‡ºï¼ˆecrecoverï¼‰ã€‚
- Header.Nonce  
Nonceå­—æ®µåœ¨ethashä¸­ç”¨æ¥ä½œä¸ºä¸€ä¸ªå˜é‡è°ƒæ•´Headerçš„å“ˆå¸Œã€‚åœ¨cliqueä¸­æ²¡æœ‰è¿™ä¸ªéœ€æ±‚ï¼Œå› æ­¤ç›´æ¥ç”¨æ¥ä¿å­˜æŠ•ç¥¨ç›®çš„ã€‚å¦‚æœå€¼ä¸ºnonceAuthVote(0xffffffffffffffff)åˆ™ä»£è¡¨è¿™æ˜¯ä¸€æ¬¡æˆæƒæŠ•ç¥¨ï¼›å¦‚æœå€¼ä¸ºnonceDropVote(0x0000000000000000)åˆ™ä»£è¡¨è¿™æ˜¯ä¸€æ¬¡è¸¢å‡ºæŠ•ç¥¨ã€‚
- Header.Extra  
åœ¨cliqueä¸­Extraé™¤äº†ä¾ç„¶ä¿å­˜vanityæ•°æ®å’ŒSealæ•°æ®ï¼Œè¿˜åœ¨checkpointä¸­å¢åŠ äº†æ‰€æœ‰ç­¾åè€…åœ°å€æ•°æ®ã€‚å…¶ç»“æ„ä¸ºï¼š  
vanityData(å›ºå®š32å­—èŠ‚)+signer1Address+signer2Address+...+SealData(å›ºå®š65å­—èŠ‚)


### æ¦‚å¿µ
è¯»æ‡‚ä¸€æ®µä»£ç çš„å…³é”®ï¼Œæ˜¯è¦ç†è§£ä½œè€…åœ¨ä»£ç ä¸­è®¾ç«‹çš„æ¦‚å¿µã€‚å› æ­¤æˆ‘ä»¬ä¸‹é¢é‡ç‚¹è§£é‡Šäº†ä¸€äº›cliqueä¸­æˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦å’Œéš¾ä»¥ç†è§£çš„æ¦‚å¿µã€‚

##### epoch and checkpoint
åœ¨cliqueä¸­ï¼Œæœ‰ä¸€ä¸ªå€¼å«åš"epoch"ã€‚å½“ä¸€ä¸ªblockçš„é«˜åº¦æ°å¥½æ˜¯"epoch"å€¼çš„æ•´æ•°å€æ—¶ï¼Œè¿™ä¸ªblockä¾¿ä¸ä¼šåŒ…å«ä»»ä½•æŠ•ç¥¨ä¿¡æ¯ï¼Œè€Œæ˜¯åŒ…å«äº†å½“å‰æ‰€æœ‰çš„ç­¾åè€…åˆ—è¡¨ã€‚è¿™ä¸ªblockè¢«å«åšcheckpointã€‚å¯ä»¥çœ‹å‡ºï¼Œcheckpointç±»ä¼¼äºä¸€ä¸ªâ€œé‡Œç¨‹ç¢‘â€ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºâ€œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ‰æ•ˆçš„ç­¾åè€…éƒ½è®°å½•åœ¨æˆ‘è¿™é‡Œäº†â€ï¼›è€Œepochå°±æ˜¯è®¾ç«‹é‡Œç¨‹ç¢‘çš„è·ç¦»ã€‚

ä¸ºä»€ä¹ˆè¦è®¾ç«‹epochè¿™ä¸ªæ¦‚å¿µå‘¢ï¼Ÿåœ¨cliqueçš„[è®¾è®¡æ–‡æ¡£](https://github.com/ethereum/EIPs/issues/225)ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œæ‘˜å½•å¦‚ä¸‹ï¼š
>To avoid having an infinite window to tally up votes in, and also to allow periodically flushing stale proposals, we can reuse the concept of an epoch from ethash, where every epoch transition flushes all pending votes. Furthermore, these epoch transitions can also act as stateless checkpoints containing the list of current authorized signers within the header extra-data. This permits clients to sync up based only on a checkpoint hash without having to replay all the voting that was done on the chain up to that point. It also allows the genesis header to fully define the chain, containing the list of initial signers.

ç®€å•æ¥è¯´ï¼Œ"epoch"çš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†é¿å…æ²¡æœ‰å°½å¤´çš„æŠ•ç¥¨çª—å£ï¼Œä¹Ÿæ˜¯ä¸ºäº†å‘¨æœŸæ€§çš„æ¸…é™¤é™¤æ—§çš„æŠ•ç¥¨ææ¡ˆã€‚æ›´è¿›ä¸€æ­¥åœ°ï¼Œåœ¨checkpointä¸­å­˜åœ¨çš„ç­¾åè€…åˆ—è¡¨ï¼Œå¯ä»¥è®©èŠ‚ç‚¹é—´åŸºäºä¸­é—´æŸä¸ªcheckpointå°±å¯ä»¥åŒæ­¥åˆ°ç­¾åè€…åˆ—è¡¨ï¼Œè€Œä¸éœ€è¦æ•´ä¸ªé“¾ä¸Šçš„æ•°æ®ã€‚

ä¸‹é¢æˆ‘æ‘˜å½•äº†éƒ¨åˆ†Clique.Prepareä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœå°†è¦ç”Ÿæˆçš„blockæ˜¯ä¸€ä¸ªcheckpointæ—¶çš„ç‰¹æ®Šå¤„ç†ï¼š
```go
func (c *Clique) Prepare(chain consensus.ChainReader, header *types.Header) error {
  //others code
  ......

  // numberä¸ºå°†è¦ç”Ÿæˆçš„å—çš„é«˜åº¦

  //å¦‚æœnumberä¸æ˜¯epochçš„æ•´æ•°å€ï¼ˆä¸æ˜¯checkpointï¼‰ï¼Œåˆ™è¿›è¡ŒæŠ•ç¥¨ä¿¡æ¯çš„å¡«å……
  if number%c.config.Epoch != 0 {
    ......

    //å¡«å†™æŠ•ç¥¨ä¿¡æ¯ï¼ˆæŠ•ç¥¨ä¿¡æ¯å­˜å‚¨åœ¨Coinbaseå’ŒNonceå­—æ®µä¸­ï¼‰
    if len(addresses) > 0 {
      header.Coinbase = addresses[rand.Intn(len(addresses))]
      if c.proposals[header.Coinbase] {
        copy(header.Nonce[:], nonceAuthVote)
      } else {
        copy(header.Nonce[:], nonceDropVote)
      }
    }
  }

  ......

  //å¦‚æœnumberæ˜¯epochçš„æ•´æ•°å€ï¼ˆå°†è¦ç”Ÿæˆä¸€ä¸ªcheckpointï¼‰ï¼Œåˆ™å¡«å……ç­¾åè€…åˆ—è¡¨
  if number%c.config.Epoch == 0 {
    for _, signer := range snap.signers() {
      header.Extra = append(header.Extra, signer[:]...)
    }
  }
}
```

åœ¨`Snapshot.apply`æ–¹æ³•ä¸­çš„ä»£ç ï¼Œåˆ™ä½“ç°äº†â€œé¿å…æ²¡æœ‰å°½å¤´çš„æŠ•ç¥¨çª—å£ï¼Œå‘¨æœŸæ€§çš„æ¸…é™¤é™¤æ—§çš„æŠ•ç¥¨ææ¡ˆâ€çš„åŠŸèƒ½ï¼š
```go
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
  ......

  for _, header := range headers {
    // Remove any votes on checkpoint blocks
    number := header.Number.Uint64()
    //å¦‚æœå½“å‰headerçš„é«˜åº¦æ˜¯epochçš„æ•´æ•°å€ï¼ˆå½“å‰blockæ˜¯ä¸€ä¸ªcheckpointï¼‰ï¼Œåˆ™æ¸…é™¤æ‰€æœ‰æŠ•ç¥¨ä¿¡æ¯å’Œç»Ÿè®¡
    //Voteså’ŒTallyå­—æ®µçš„è¯¦ç»†ä¿¡æ¯å‚çœ‹å¯¹Snapshotçš„ä»‹ç»ã€‚
    if number%s.config.Epoch == 0 {
      snap.Votes = nil
      snap.Tally = make(map[common.Address]Tally)
    }

    ......
  }
}
```

è¿™é‡Œç¨å¾®è¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¸€ç‚¹ä»£ç å®ç°äº†epochçš„è®¾è®¡ç›®çš„ã€‚ä¸€ä¸ªSnapshotå¯¹è±¡ä¸­ä¿å­˜äº†åœ¨æŸä¸ªé«˜åº¦ä¸Šçš„æŠ•ç¥¨ä¿¡æ¯ï¼Œè€Œåˆ›å»ºä¸€ä¸ªSnapshotå¯¹è±¡å…¶å®æ˜¯åˆ†ä¸¤æ­¥çš„ï¼Œapplyæ–¹æ³•å±äºç¬¬äºŒæ­¥ã€‚å‡å¦‚ç»™applyä¼ å…¥10ä¸ªheaderï¼Œå…¶ä¸­ç¬¬8ä¸ªçš„é«˜åº¦æ°å¥½æ˜¯epochçš„æ•´æ•°å€ï¼Œé‚£ä¹ˆå‰é¢é‚£7ä¸ªçš„æŠ•ç¥¨ä¿¡æ¯å°±è¢«æŠ¹å»äº†ã€‚


##### checkpointInterval
é™¤äº†epochï¼Œä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªå€¼ä¸ºcheckpointIntervalã€‚å½“åœ¨æŸä¸ªblockä¸Šåˆ›å»ºä¸€ä¸ªSnapshotå¯¹è±¡ï¼Œä¸”è¿™ä¸ªblockçš„é«˜åº¦æ˜¯checkpointIntervalçš„æ•´æ•°å€æ—¶ï¼Œåˆ™å°†è¿™ä¸ªSnapshotå¯¹è±¡å†™å…¥åˆ°æ•°æ®åº“ä¸­æ°¸ä¹…å­˜å‚¨ï¼›ä»¥åæƒ³åˆ°å†æ¬¡åœ¨è¿™ä¸ªblockä¸Šç”ŸæˆSnapshotå¯¹è±¡æ—¶ï¼Œç›´æ¥ä»æ•°æ®åº“ä¸­è¯»å–å°±å¯ä»¥äº†ã€‚æ‘˜å½•ä»£ç å¦‚ä¸‹ï¼š
```go
func (c *Clique) snapshot(chain consensus.ChainReader, number uint64, hash common.Hash, parents []*types.Header) (*Snapshot, error) {
  ......

  for snap == nil {
    ......

    //å¦‚æœé«˜åº¦ä¸ºcheckpointIntervalçš„æ•´æ•°å€ï¼Œåˆ™ç›´æ¥å°è¯•ä»æ•°æ®åº“ä¸­è¯»å–Snapshotå¯¹è±¡
    if number%checkpointInterval == 0 {
      if s, err := loadSnapshot(c.config, c.signatures, c.db, hash); err == nil {
        snap = s
        break
      }
    }

    ......
  }

  ......

  //å¦‚æœé«˜åº¦ä¸ºcheckpointIntervalçš„æ•´æ•°å€ï¼Œåˆ™å°†Snapshotå¯¹è±¡å­˜å‚¨åˆ°æ•°æ®åº“ä¸­
  if snap.Number%checkpointInterval == 0 && len(headers) > 0 {
    if err = snap.store(c.db); err != nil {
      return nil, err
    }
  }
  return snap, err
}
```

##### Snapshot
Snapshotå¯¹è±¡æ˜¯cliqueä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»Ÿè®¡å¹¶ä¿å­˜é“¾çš„æŸæ®µé«˜åº¦åŒºé—´çš„æŠ•ç¥¨ä¿¡æ¯å’Œç­¾åè€…åˆ—è¡¨ã€‚è¿™ä¸ªç»Ÿè®¡åŒºé—´æ˜¯ä»æŸä¸ªcheckpointå¼€å§‹ï¼ˆåŒ…æ‹¬genesis blockï¼‰ï¼Œåˆ°æŸä¸ªæ›´é«˜é«˜åº¦çš„blockã€‚åœ¨Snapshotå¯¹è±¡ä¸­ç”¨åˆ°äº†ä¸¤ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼šVoteå’ŒTallyï¼Œæˆ‘ä»¬å…ˆå¯¹å®ƒä»¬è¿›è¡Œä¸€ä¸‹è¯´æ˜ï¼Œå†æ¥è¯¦ç»†è¯´ä¸€ä¸‹Snapshotç»“æ„ä½“ã€‚

- Vote struct

Voteä»£è¡¨çš„æ˜¯ä¸€æ¬¡æŠ•ç¥¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è°ç»™è°æŠ•çš„ç¥¨ã€æŠ•çš„åŠ å…¥ç¥¨è¿˜æ˜¯è¸¢å‡ºç¥¨ç­‰ç­‰ã€‚å®ƒçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š
```go
type Vote struct {
  Signer    common.Address // æ­¤æ¬¡æŠ•ç¥¨æ˜¯ç”±è°æŠ•çš„
  Block     uint64         // æ­¤æ¬¡æŠ•ç¥¨æ˜¯åœ¨å“ªä¸ªé«˜åº¦çš„blockä¸ŠæŠ•çš„
  Address   common.Address // æ­¤æ¬¡æŠ•ç¥¨æ˜¯æŠ•ç»™è°çš„
  Authorize bool           // è¿™æ˜¯ä¸€ä¸ªåŠ å…¥ç¥¨ï¼ˆç”³è¯·è¢«æŠ•äººæˆä¸ºç­¾åè€…ï¼‰è¿˜æ˜¯è¸¢å‡ºç¥¨ï¼ˆç”³è¯·å°†è¢«æŠ•äººè¸¢å‡ºç­¾åè€…åˆ—è¡¨ï¼‰
}
```

- Tally struct

Tallyç»“æ„ä½“æ˜¯å¯¹æ‰€æœ‰è¢«æŠ•äººçš„æŠ•ç¥¨ç»“æœç»Ÿè®¡ã€‚æ³¨æ„å®ƒä¸Voteç»“æ„ä½“çš„åŒºåˆ«ï¼šVoteæ˜¯æŠ•ç¥¨è¿‡ç¨‹çš„è®°å½•ï¼ˆå¦‚Aç»™BæŠ•äº†ä¸€ä¸ªæˆæƒç¥¨ï¼‰ï¼Œè€ŒTallyæ˜¯å¯¹ç»“æœçš„ç»Ÿè®¡ï¼ˆç±»ä¼¼äºé€‰ç­é•¿å”±ç¥¨æ—¶è®¡ç¥¨å‘˜åœ¨é»‘æ¿ä¸Šç”»çš„â€œæ­£â€å­—ï¼‰ã€‚Tallyçš„å®šä¹‰å¦‚ä¸‹ï¼š
```go
type Tally struct {
  Authorize bool // è¿™æ˜¯åŠ å…¥ç¥¨çš„ç»Ÿè®¡è¿˜æ˜¯è¸¢å‡ºç¥¨çš„ç»Ÿè®¡
  Votes     int  // ç›®å‰ä¸ºæ­¢ç´¯è®¡çš„ç¥¨æ•°
}
```

å¦‚æœåªçœ‹è¿™é‡Œä½ å¯èƒ½ä¼šæ„å¤–è¿™é‡Œå¹¶æ²¡æœ‰â€œé’ˆå¯¹è°è¿›è¡Œçš„ç»Ÿè®¡â€çš„ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºTallyåœ¨Snapshotç»“æ„ä½“æ˜¯æ˜¯ä½œä¸ºmapçš„ä¸€éƒ¨åˆ†çš„ï¼Œå‚çœ‹ä¸‹é¢å¯¹Snapshotç»“æ„ä½“å­—æ®µçš„è¯´æ˜ã€‚

- Snapshot struct

å‰é¢æˆ‘ä»¬å·²ç»è¯´æ˜äº†Snapshotç»“æ„ä½“çš„æ„ä¹‰ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥çœ‹ä¸€ä¸‹ç»“æ„ä½“çš„å®šä¹‰ï¼š
```go
type Snapshot struct {
  config   *params.CliqueConfig
  sigcache *lru.ARCCache        

  Number  uint64                      // Block number where the snapshot was created
  Hash    common.Hash                 // Block hash where the snapshot was created
  Signers map[common.Address]struct{} // å½“å‰çš„æ‰€æœ‰æœ‰æ•ˆçš„ç­¾åè€…
  Recents map[uint64]common.Address   // æœ€è¿‘ç”Ÿæˆè¿‡blockçš„ç­¾åè€…ã€‚å…¶ä¸­mapçš„keyæ˜¯ç”Ÿæˆçš„blockçš„é«˜åº¦
  Votes   []*Vote                     // æŒ‰æ—¶é—´å…ˆåé¡ºåºä¿å­˜çš„æŠ•ç¥¨ä¿¡æ¯
  Tally   map[common.Address]Tally    // ç›®å‰ä¸ºæ­¢ç´¯è®¡å„è¢«æŠ•äººçš„ç¥¨æ•°
}
```

é™¤äº†Voteså’ŒTallyï¼Œæ¯”è¾ƒé‡è¦çš„å­—æ®µå°±æ˜¯Signerså’ŒRecentsäº†ã€‚Signerså­—æ®µæ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯å½“å‰å¯ä»¥å‡ºå—çš„æ‰€æœ‰çš„ç­¾åè€…ã€‚å„ä¸ªèŠ‚ç‚¹æ ¹æ®è¿™ä¸ªå­—æ®µçš„ä¿¡æ¯æ¥åˆ¤æ–­æŸä¸ªå—çš„ç­¾åè€…æ˜¯å¦çœŸçš„æœ‰æƒå‡ºå—ã€‚æ³¨æ„è¿™ä¸ªå­—æ®µæ˜¯å¯ä»¥ä¸æ–­åŠ¨æ€å˜åŒ–çš„ï¼Œå½“æŸä¸ªè´¦å·åœ°å€çš„ç´¯è®¡æŠ•ç¥¨æ•°è¶…è¿‡ä¸€åŠæ—¶ï¼Œå°±ä¼šè¢«åŠ å…¥åˆ°Signersä¸­ï¼ˆæˆ–ä»Signersä¸­ç§»é™¤ï¼‰ï¼Œå®ç°ä»£ç æ‘˜å½•å¦‚ä¸‹ï¼š
```go
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
  for _, header := range headers {
    ......

    //å¦‚æœç´¯è®¡æŠ•ç¥¨æ•°è¶…è¿‡ä¸€åŠ
    if tally := snap.Tally[header.Coinbase]; tally.Votes > len(snap.Signers)/2 {
      if tally.Authorize {
        //å¦‚æœæ˜¯åŠ å…¥ç¥¨ï¼Œåˆ™å°†è¢«æŠ•äººåŠ å…¥åˆ°Signersåˆ—è¡¨ä¸­
        snap.Signers[header.Coinbase] = struct{}{}
      } else {
        //å¦‚æœæ˜¯è¸¢å‡ºç¥¨ï¼Œåˆ™æŠŠè¢«æŠ•äººä»Signersä¸­åˆ é™¤
        delete(snap.Signers, header.Coinbase)

        //å°†è¢«æŠ•äººä»Recentsä¿¡æ¯ä¸­åˆ é™¤
        if limit := uint64(len(snap.Signers)/2 + 1); number >= limit {
          delete(snap.Recents, number-limit)
        }

        //ä¸¢å¼ƒè¢«æŠ•äººä¹‹å‰æŠ•å‡ºçš„æ‰€æœ‰æŠ•ç¥¨
        for i := 0; i < len(snap.Votes); i++ {
          if snap.Votes[i].Signer == header.Coinbase {
            snap.uncast(snap.Votes[i].Address, snap.Votes[i].Authorize)
            snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
            i--
          }
        }
      }

      //æ¸…é™¤æ‰€æœ‰è¢«æŠ•äººæ˜¯å½“å‰ç”Ÿæ•ˆäººçš„æŠ•ç¥¨ä¿¡æ¯
      for i := 0; i < len(snap.Votes); i++ {
        if snap.Votes[i].Address == header.Coinbase {
          snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
          i--
        }
      }
      delete(snap.Tally, header.Coinbase)  //æ¸…ç©ºå½“å‰ç”Ÿæ•ˆäººçš„ç¥¨æ•°ç»Ÿè®¡ä¿¡æ¯
    }
  }

  ......
}
```

`Snapshot.Recents`å­—æ®µä¿å­˜äº†æœ€è¿‘å‡ºå—çš„ç­¾åè€…å’Œæ‰€å‡ºçš„å—çš„é«˜åº¦ã€‚è¿™ä¸ªâ€œæœ€è¿‘â€çš„å®šä¹‰æ˜¯æœ€æ–°çš„`len(Snapshot.Signers)/2 + 1`ä¸ªå—ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä»£ç æ˜¯å¦‚ä½•æ“ä½œè¿™ä¸ªå­—æ®µçš„ï¼š
```go
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
  for _, header := range headers {
    ......

    //å°†é«˜åº¦ä¸å½“å‰å—ç›¸å·®limitçš„å—ä»Recentsä¸­åˆ é™¤æ‰
    if limit := uint64(len(snap.Signers)/2 + 1); number >= limit {
      delete(snap.Recents, number-limit)
    }
    ......

    //å°†å½“å‰å—çš„é«˜åº¦å’Œç­¾åè€…åŠ å…¥Recentsä¸­
    snap.Recents[number] = signer
  }
}
```

æ¯”å¦‚ç›®å‰æœ‰6ä¸ªç­¾åè€…ï¼Œå½“å‰å—çš„é«˜åº¦æ˜¯10ï¼Œé‚£ä¹ˆé«˜åº¦ä¸º"10 - (6/2 + 1) = 6"çš„å—å°†ä»Recentsä¸­åˆ é™¤ï¼Œç„¶åå°†é«˜åº¦ä¸º10çš„å—å’Œå…¶ç­¾åè€…åŠ å…¥Recentsä¸­ï¼›å¤„ç†ä¸€ä¸‹ä¸ªå—å³é«˜åº¦ä¸º11æ—¶ï¼Œé«˜åº¦ä¸º7çš„å—åˆä¼šä»Recentsä¸­åˆ é™¤ï¼Œç„¶åé«˜åº¦ä¸º11çš„å—ä¼šè¢«åŠ å…¥ã€‚æ€»ä¹‹ï¼Œè¿™ä¸ª"æœ€è¿‘"çš„åŸºç‚¹æ˜¯å½“å‰å—çš„é«˜åº¦ï¼Œå›Šæ‹¬çš„èŒƒå›´ä¸º`len(Snapshot.Signers)/2 + 1`ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åœ¨å‡ºå—æ—¶Recentså­—æ®µæ˜¯å¦‚ä½•èµ·ä½œç”¨çš„ï¼š
```go
func (c *Clique) Seal(chain consensus.ChainReader, block *types.Block, results chan<- *types.Block, stop <-chan struct{}) error {
  ......

  for seen, recent := range snap.Recents {
    if recent == signer {
      // Signer is among recents, only wait if the current block doesn't shift it out
      if limit := uint64(len(snap.Signers)/2 + 1); number < limit || seen > number-limit {
        log.Info("Signed recently, must wait for others")
        return nil
      }
    }
  }

  ......
}
```

åœ¨å‡†å¤‡ä¸ºæ–°çš„blockç­¾åæ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰çš„ç­¾åè€…æ˜¯ä¸æ˜¯åœ¨Recentsä¸­ï¼Œå¦‚æœåœ¨åˆ™ä¸å†ç­¾åã€‚ï¼ˆè¿™é‡Œä»ç„¶æœ‰å¯¹limitçš„åˆ¤æ–­ï¼Œä½†æˆ‘è§‰å¾—å…¶å®æ˜¯æ²¡æœ‰å¿…è¦äº†ã€‚ä¹Ÿå¯èƒ½æ˜¯æˆ‘æ²¡çœ‹æ‡‚......ï¼‰


æœ€åï¼Œæˆ‘ä»¬è¦è¯´ä¸€ä¸‹Snapshotçš„åˆ›å»ºè¿‡ç¨‹ã€‚å‰é¢å…¶å®æåˆ°è¿‡ï¼ŒSnapshotçš„åˆ›å»ºåˆ†ä¸¤æ­¥ï¼šä¸€æ˜¯åœ¨æŸä¸ªcheckpoint(åŒ…æ‹¬genesis block)ä¸Šè°ƒç”¨`newSnapshot`ç”Ÿæˆä¸€ä¸ªSnapshotå¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„applyæ–¹æ³•ã€‚è¿™ä¸¤æ­¥è¢«å°è£…åœ¨äº†`Clique.snapshot`æ–¹æ³•ä¸­ï¼Œå³`Clique.snapshot`æ‰æ˜¯æ­£ç¡®ç”ŸæˆSnapshotå¯¹è±¡çš„æ–¹æ³•ã€‚å› æ­¤æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹Cliqueçš„snapshotæ–¹æ³•ã€‚ä¸‹é¢æ˜¯æ‘˜å½•çš„ä»£ç ï¼Œä¸ºäº†æ›´æ¸…æ¥šçš„è¡¨è¾¾é€»è¾‘ï¼Œå¯¹ä»£ç è¿›è¡Œäº†ç®€åŒ–ï¼Œå¹¶åŠ äº†ä¸€äº›ä¼ªä»£ç ï¼š
```go
func (c *Clique) snapshot(chain consensus.ChainReader, number uint64, hash common.Hash, parents []*types.Header) (*Snapshot, error) {
  headers []*types.Header

  for snap == nil {
    //é¦–å…ˆä»ç¼“å­˜æˆ–æ•°æ®åº“ä¸­æŸ¥æ‰¾
    if snapshot in cache or database {
      get and break
    }

    //æ—¢ä¸åœ¨ç¼“å­˜ä¸­ä¹Ÿä¸åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆçœ‹æ˜¯å¦æ˜¯åˆ›ä¸–å—æˆ–æ²¡æœ‰çˆ¶å—çš„checkpointã€‚
    //å…³äºä¸ºä»€ä¹ˆè¦åˆ¤æ–­æ²¡æœ‰çˆ¶å—çš„checkpointï¼Œåé¢æœ‰è¯¦ç»†è¯´æ˜
    if number == 0 || (number%c.config.Epoch == 0 && chain.GetHeaderByNumber(number-1) == nil) {
      checkpoint := chain.GetHeaderByNumber(number)

      //ä»checkpointä¸­å–å‡ºsignersåˆ—è¡¨
      signers := make([]common.Address, (len(checkpoint.Extra)-extraVanity-extraSeal)/common.AddressLength)
      for i := 0; i < len(signers); i++ {
        copy(signers[i][:], checkpoint.Extra[extraVanity+i*common.AddressLength:])
      }

      //è°ƒç”¨newSnapshotåœ¨checkpointä¸Šåˆ›å»ºSnapshotå¯¹è±¡ï¼Œå¹¶å°†å…¶å­˜å…¥æ•°æ®åº“ä¸­
      snap = newSnapshot(c.config, c.signatures, number, checkpoint.Hash(), signers)
      snap.store(c.db)
      break
    }

    //å¦‚æœä»¥ä¸Šæƒ…å†µéƒ½ä¸æ˜¯ï¼Œåˆ™å¾€å‰å›æº¯åŒºå—çš„é“¾ï¼Œå¹¶ä¿å­˜å›æº¯è¿‡ç¨‹ä¸­é‡åˆ°çš„header
    header := get parent by number and hash
    headers = append(headers, header)
    number, hash = number-1, header.ParentHash
  }

  //æŠŠheadersä¸­ä¿å­˜çš„å¤´ä»æŒ‰é«˜åº¦ä»å°åˆ°å¤§æ’åºã€‚
  reverse(headers)

  //å°†å›æº¯ä¸­é‡åˆ°çš„headersä¼ ç»™applyæ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„snapå¯¹è±¡
  snap, err := snap.apply(headers)

  //ä¿å­˜snapå¯¹è±¡
  store snap to cache
  if should store to database {
    snap.store(c.db)
  }
  return snap, err
}
```

ä»ä¸Šé¢ç®€åŒ–çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæƒ³è¦åˆ›å»ºä¸€ä¸ªSnapshotå¯¹è±¡ï¼Œéœ€è¦ä»ç»™å®šçš„blockå¼€å§‹å‘å‰å›æº¯ï¼Œç›´åˆ°ä»ç¼“å­˜æˆ–æ•°æ®åº“ä¸­æ‰¾åˆ°å¯¹åº”çš„Snapshotï¼Œæˆ–è€…æ»¡è¶³`number == 0 || (number%c.config.Epoch == 0 && chain.GetHeaderByNumber(number-1) == nil)`è¿™ä¸ªå¥‡æ€ªçš„æ¡ä»¶ã€‚ç„¶åå°†å›æº¯è¿‡ç¨‹ä¸­é‡åˆ°çš„headerä¼ ç»™applyã€‚åœ¨applyå†…éƒ¨ä¼šæ ¹æ®ä¼ å…¥çš„headersé€ä¸ªç»Ÿè®¡æŠ•ç¥¨ç­‰ä¿¡æ¯ã€‚

å…³äºä¸Šé¢æåˆ°çš„è¿™ä¸ªå¥‡æ€ªçš„åˆ¤æ–­æ¡ä»¶çš„åˆ†æï¼Œå‚çœ‹[å¥‡æ€ªçš„åˆ¤æ–­æ¡ä»¶](#odd_if)è¿™ä¸€å°èŠ‚é‡Œçš„è¯´æ˜ã€‚

##### inturn and noturn
å‰é¢è¯´è¿‡ï¼Œcliqueä½œä¸ºPoAçš„å®ç°ï¼ŒæŒ–çŸ¿çš„äººä¹‹é—´æ˜¯åˆä½œå…³ç³»ï¼Œå› æ­¤éœ€è¦æœ‰è§„åˆ™è§„å®šæŸä¸€æ—¶åˆ»åº”è¯¥ç”±è°å‡ºå—ã€‚åœ¨cliqueä¸­ï¼Œ`inturn`çŠ¶æ€ä»£è¡¨çš„æ˜¯â€œæŒ‰é“ç†è½®åˆ°æˆ‘å‡ºå—äº†â€ï¼Œè€Œ`noturn`æ­£å¥½ç›¸åã€‚

åœ¨ä»£ç ä¸­ï¼Œinturnçš„å€¼ä¸º`diffInTurn`ï¼Œnoturnçš„å€¼ä¸º`diffNoTurn`ã€‚Header.Difficultyå­—æ®µç”¨æ¥ä¿å­˜ç›¸åº”çš„å€¼ï¼Œå®ƒçš„è®¡ç®—æ–¹å¼éå¸¸ç®€å•ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹Snapshot.inturnæ–¹æ³•ï¼Œè¿™é‡Œä¸å†å¤šè¯´ã€‚

åœ¨`Clique.Seal`æ–¹æ³•ä¸­ï¼Œç­¾åæ—¶ä¼šè¿›è¡Œä¸€å®šæ—¶é—´çš„ç­‰å¾…ã€‚å¦‚æœHeader.Difficultyçš„å€¼ä¸º`diffNoTurn`ï¼Œåˆ™ä¼šæ¯”`diffInTurn`çš„å—éšæœºå¤šç­‰å¾…ä¸€äº›æ—¶é—´ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯è½®åˆ°å‡ºå—çš„äººå¯ä»¥ä¼˜å…ˆå‡ºå—ã€‚ä»£ç å¦‚ä¸‹ï¼š
```go
func (c *Clique) Seal(chain consensus.ChainReader, block *types.Block, results chan<- *types.Block, stop <-chan struct{}) error {
  ......

  //è®¡ç®—æ­£å¸¸çš„ç­‰å¾…å‡ºå—æ—¶é—´
  delay := time.Unix(header.Time.Int64(), 0).Sub(time.Now()) // nolint: gosimple
  if header.Difficulty.Cmp(diffNoTurn) == 0 {
    //æ²¡æœ‰è½®åˆ°æˆ‘ä»¬å‡ºå—ï¼Œå¤šç­‰ä¸€ä¼š
    // It's not our turn explicitly to sign, delay it a bit
    wiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime
    delay += time.Duration(rand.Int63n(int64(wiggle)))

    log.Trace("Out-of-turn signing requested", "wiggle", common.PrettyDuration(wiggle))
  }

  ......
}
```


### å‡ºå—æµç¨‹
åœ¨ç†è§£äº†å‰é¢æåˆ°çš„ä¸€äº›æ¦‚å¿µä»¥åï¼Œæˆ‘è§‰å¾—å†åŠ ä¸Šä¸€ä¸ªæ•´ä½“çš„è§†å›¾ï¼Œcliqueæ¨¡å—å°±éå¸¸å®¹æ˜“ç†è§£äº†ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä»ä¸€ä¸ªæ›´é«˜çš„è§†è§’æ¥çœ‹ä¸€ä¸‹cliqueçš„å·¥ä½œæµç¨‹ã€‚

Cliqueå¯¹è±¡åŒ…å«ä¸¤å¤§å—åŠŸèƒ½ï¼šHeaderçš„æœ‰æ•ˆæ€§éªŒè¯å’Œç”Ÿæˆæ–°çš„Headerã€‚æœ‰æ•ˆæ€§éªŒè¯çš„æ–¹æ³•å…¨éƒ½æ˜¯ä»¥"Verify"å¼€å¤´ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå°±ä¸å¤šè¯´äº†ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹ç”Ÿæˆæ–°çš„blockçš„æµç¨‹ã€‚æˆ‘å°†å…³é”®ä¿¡æ¯æ•´ç†æˆäº†ä¸€å¼ æµç¨‹å›¾ã€‚ç”±äºCliqueå¯¹è±¡åªæ˜¯å®ç°äº†ä»¥å¤ªåŠä¸­å…±è¯†æ¥å£çš„æ–¹æ³•ï¼Œä¸»è¦æµç¨‹è¿˜æ˜¯ç”±mineræ¨¡å—æ§åˆ¶ï¼Œå› æ­¤è¿™é‡Œä¹ŸåŠ å…¥äº†ç®€å•çš„mineræ¨¡å—çš„æµç¨‹ã€‚

![](/pic/ethereum-clique/flowchart.png)

è¿™å¼ å›¾é‡Œéšè—äº†Snapshotçš„åŠŸèƒ½ã€‚æ•´ä¸ªå‡ºå—çš„åŠŸèƒ½ä¸»è¦ç”±Prepareå’ŒSealå®Œæˆã€‚åœ¨Prepareä¸­å‡†å¤‡ä¸€äº›ä¸PoAç›¸å…³çš„ä¿¡æ¯ï¼Œåœ¨Sealä¸­è¿›è¡Œç­¾åå‡ºå—ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå‡ºå—çš„æ—¶é—´æ˜¯åœ¨Sealä¸­æ§åˆ¶çš„ï¼Œè€Œéminerä¸­ã€‚


# å…³é”®é—®é¢˜
å‰é¢çš„åˆ†æå·²ç»æ¶‰åŠäº†å‡ ä¹cliqueæ¨¡å—çš„æ‰€æœ‰é‡ç‚¹ï¼Œä½†ä¸ºäº†æ¸…æ™°ï¼Œè¿™é‡ŒæŠŠä¸€äº›éœ€è¦é‡ç‚¹å…³æ³¨çš„å…³é”®é—®é¢˜å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå†é’ˆå¯¹æ€§çš„è¿›è¡Œä¸€æ¬¡è¯´æ˜ã€‚

### å¦‚ä½•æ§åˆ¶å‡ºå—æ—¶æœº
æ‰€æœ‰çš„å…±è¯†æœºåˆ¶éƒ½éœ€è¦æœ‰ä¸€å¥—æ§åˆ¶å‡ºå—æ—¶æœºçš„æ–¹æ³•ï¼Œå› ä¸ºä¸å¯èƒ½åœ¨åŒä¸€æ—¶é—´è®©æ‰€æœ‰äººéƒ½å‡ºå—ã€‚cliqueæ˜¯é€šè¿‡ä¸¤ä¸ªæ–¹é¢å¯¹å‡ºå—æ—¶æœºè¿›è¡Œæ§åˆ¶çš„ï¼š
1. recentåˆ—è¡¨
2. inturnæˆ–noturn

åœ¨cliqueä¸­ï¼Œä¸å…è®¸æœ€è¿‘å‡ºè¿‡å—çš„äººå†å‡ºå—ï¼Œå¿…é¡»é—´éš”ä¸€å®šçš„é«˜åº¦ï¼Œè¿™æ˜¯é€šè¿‡`Snapshot.Recents`å­—æ®µæ§åˆ¶çš„ã€‚åœ¨`Clique.Seal`æ–¹æ³•ä¸­æœ‰å¦‚ä¸‹ä¸€æ®µä»£ç ï¼š
```go
  for seen, recent := range snap.Recents {
    if recent == signer {
      // Signer is among recents, only wait if the current block doesn't shift it out
      if limit := uint64(len(snap.Signers)/2 + 1); number < limit || seen > number-limit {
        log.Info("Signed recently, must wait for others")
        return nil
      }
    }
  }
```

ä»£ç ä¸­`snap.Recents`ä¿å­˜çš„å°±æ˜¯æœ€è¿‘å‡ºçš„å—çš„é«˜åº¦å’Œå—çš„ç­¾åè€…ï¼ˆsignerï¼‰ï¼Œ`seen`å˜é‡æ˜¯å—çš„é«˜åº¦ï¼Œ`recent`æ˜¯è¿™ä¸ªå—çš„ç­¾åè€…ã€‚è¿™æ®µä»£ç è¡¨è¾¾çš„æ„æ€æ˜¯ï¼Œå¦‚æœå½“å‰çš„ç­¾åè€…åˆšå‡ºè¿‡å—ï¼ˆåœ¨Recentsä¸­ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå†å²å—çš„é«˜åº¦ç¦»æ–°å‡ºå—çš„é«˜åº¦ç›¸å·®åœ¨æ‰€æœ‰ç­¾åè€…æ•°é‡çš„ä¸€åŠï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯ä¸€åŠåŠ 1ï¼‰ä»¥å†…ï¼Œåˆ™ä¸å…è®¸å†å‡ºå—ã€‚

æ¯”å¦‚ç›®å‰å…±æœ‰7ä¸ªç­¾åè€…ï¼Œå°†è¦æ–°å‡ºçš„å—é«˜åº¦ä¸º100ï¼Œè€Œæˆ‘åˆšå‡ºè¿‡ä¸€ä¸ªå—çš„é«˜åº¦æ˜¯97ï¼Œé‚£ä¹ˆè¿™ä¸ªé«˜åº¦ä¸º100çš„å—æˆ‘å°±ä¸èƒ½å†å‡ºäº†ã€‚ï¼ˆ97 > 100 - (7/2 + 1)ï¼‰

é‚£ä¹ˆsnap.Recentsåˆæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿå®ƒæ˜¯åœ¨`Snapshot.apply`ä¸­ç”Ÿæˆçš„ï¼š
```go
  // Delete the oldest signer from the recent list to allow it signing again
  if limit := uint64(len(snap.Signers)/2 + 1); number >= limit {
    delete(snap.Recents, number-limit)
  }
  // Resolve the authorization key and check against signers
  signer, err := ecrecover(header, s.sigcache)

  snap.Recents[number] = signer
```

å¯ä»¥çœ‹åˆ°åœ¨å¡«å……Recentsæ—¶ï¼Œä¼šå°†é«˜åº¦æ¯”å½“å‰å—å°å¤ªå¤šçš„å—ä»Recentsä¸­è¸¢å‡ºå»ï¼ˆnumber - limitï¼‰ã€‚

ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨Sealæ—¶ï¼Œå…¶å®æ˜¯æœ‰å¤§çº¦ä¸€åŠæ•°é‡çš„ç­¾åè€…éƒ½æ˜¯å¯ä»¥å‡ºå—çš„ã€‚é‚£è¿™ä¸€åŠçš„ç­¾åè€…éƒ½è¦å‡ºå—å—ï¼Ÿå½“ç„¶ä¸æ˜¯çš„ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªæ—¶åˆ»æœ€å¥½åªæœ‰ä¸€ä¸ªäººå‡ºå—ã€‚åœ¨cliqueä¸­æ˜¯ä½¿ç”¨inturn/noturnçš„æœºåˆ¶å®ç°çš„ã€‚

åœ¨å‰é¢çš„æ¦‚å¿µä»‹ç»æ—¶æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡inturnæ¦‚å¿µï¼Œç®€å•æ¥è¯´å°±æ˜¯â€œå½“å‰æ˜¯ä¸æ˜¯è½®åˆ°æˆ‘å‡ºå—äº†â€ï¼Œåˆ¤æ–­æ–¹æ³•æ˜¯çœ‹å½“å‰å—çš„é«˜åº¦æ˜¯å¦å’Œè‡ªå·±åœ¨ç­¾åè€…åˆ—è¡¨ä¸­çš„é¡ºåºä¸€è‡´ã€‚`Snapshot.inturn`æ–¹æ³•å®ç°äº†è¿™ä¸€åŠŸèƒ½ï¼š
```go
func (s *Snapshot) inturn(number uint64, signer common.Address) bool {
  signers, offset := s.signers(), 0
  for offset < len(signers) && signers[offset] != signer {
    offset++
  }
  return (number % uint64(len(signers))) == uint64(offset)
}
```

åœ¨`Clique.Prepare`ä¸­ä¼šå°†â€œæ˜¯å¦è½®åˆ°è‡ªå·±â€çš„å€¼å†™åˆ°Header.Difficultyå­—æ®µä¸­ï¼š
```go
func (c *Clique) Prepare(chain consensus.ChainReader, header *types.Header) error {
  ......
  header.Difficulty = CalcDifficulty(snap, c.signer)
  ......
}

func CalcDifficulty(snap *Snapshot, signer common.Address) *big.Int {
  if snap.inturn(snap.Number+1, signer) {
    return new(big.Int).Set(diffInTurn)
  }
  return new(big.Int).Set(diffNoTurn)
}
```

ç„¶ååœ¨`Clique.Seal`ä¸­ï¼Œä¼šæ ¹æ®Header.Difficultyä¸­çš„å€¼åˆ¤æ–­â€œæ˜¯å¦è½®åˆ°è‡ªå·±â€å‡ºå—ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¦éšæœºå¤šç­‰å¾…ç‚¹æ—¶é—´ï¼Œè¿™å°±ç»™äº†è¯¥å‡ºå—çš„äººä¼˜å…ˆçš„å‡ºå—æƒï¼š
```go
func (c *Clique) Seal(chain consensus.ChainReader, block *types.Block, results chan<- *types.Block, stop <-chan struct{}) error {
  ......
  delay := time.Unix(header.Time.Int64(), 0).Sub(time.Now())
  if header.Difficulty.Cmp(diffNoTurn) == 0 {
    // It's not our turn explicitly to sign, delay it a bit
    wiggle := time.Duration(len(snap.Signers)/2+1) * wiggleTime
    delay += time.Duration(rand.Int63n(int64(wiggle)))
  }
}
```

æ‰€ä»¥ï¼Œcliqueé€šè¿‡recentå’Œinturnä¸¤ç§æ–¹å¼æ§åˆ¶å‡ºå—æ—¶æœºï¼Œæœ€ç»ˆç»™äº†è¯¥å‡ºå—çš„äººä¼˜å…ˆçš„å‡ºå—æƒã€‚


### å¦‚ä½•åŠ¨æ€è°ƒæ•´ç­¾åè€…åˆ—è¡¨
å‰é¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼Œåœ¨é¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç­¾åè€…å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ä¸€ç§æœºåˆ¶èƒ½åŠ¨æ€çš„è°ƒæ•´ç­¾åè€…åå•ã€‚åœ¨cliqueä¸­ï¼Œè¿™ç§è°ƒæ•´æ˜¯é€šè¿‡æŠ•ç¥¨å®ç°çš„ã€‚å³å¯¹æ˜¯å¦è¦åŠ å…¥æˆ–è¸¢é™¤æŸäººï¼Œç°æœ‰ç­¾åè€…å¯ä»¥å‘èµ·æŠ•ç¥¨ï¼Œå½“æŠ•ç¥¨è¶…è¿‡åŠæ•°æ—¶æŠ•ç¥¨é€šè¿‡ï¼Œè¢«æŠ•äººè¢«è‡ªåŠ¨åŠ å…¥æˆ–è¸¢å‡ºã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ç§æŠ•ç¥¨æœºåˆ¶æ˜¯æ€ä¹ˆå®ç°çš„ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä½•å‘èµ·æŠ•ç¥¨ã€‚ä½ å¯ä»¥åœ¨consoleä¸­è°ƒç”¨`clique.propose`æ¥è¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼Œæ¯”å¦‚ï¼š
> clique.propose("0x8D5cC3e43CE479d81c7e1e4a6DebC8D6c126a9eF", true)

è°ƒç”¨æ­¤æ–¹æ³•ä»¥åï¼ŒæŠ•ç¥¨ä¿¡æ¯å°±ä¼šå†™å…¥`Clique.proposals`å­—æ®µä¸­ã€‚åœ¨éšåå‡ºå—è°ƒç”¨`Clique.Prepare`æ–¹æ³•æ—¶ï¼Œä¼šä»`Clique.proposals`ä¸­éšæœºé€‰æ‹©ä¸€æ¡æŠ•ç¥¨ä¿¡æ¯ï¼Œæ”¾åˆ°Header.Coinbaseå’ŒHeader.Nonceä¸­ï¼š
```go
func (c *Clique) Prepare(chain consensus.ChainReader, header *types.Header) error {
  ......

  //écheckpointæ‰å¯ä»¥æºå¸¦æŠ•ç¥¨ä¿¡æ¯
  if number%c.config.Epoch != 0 {
    //ä»c.proposalsä¸­æ”¶é›†æ‰€æœ‰æœ‰æ„ä¹‰çš„è¢«æŠ•åœ°å€
    addresses := make([]common.Address, 0, len(c.proposals))
    for address, authorize := range c.proposals {
      if snap.validVote(address, authorize) {
        addresses = append(addresses, address)
      }
    }

    //å¦‚æœç¡®å®æœ‰æœ‰æ„ä¹‰çš„è¢«æŠ•åœ°å€ï¼Œéšæœºé€‰ä¸€ä¸ªå¡«å…¥Headerä¸­
    if len(addresses) > 0 {
      header.Coinbase = addresses[rand.Intn(len(addresses))]
      if c.proposals[header.Coinbase] {
        copy(header.Nonce[:], nonceAuthVote)
      } else {
        copy(header.Nonce[:], nonceDropVote)
      }
    }
  }

  ......
}
```

ç°åœ¨ç¥¨å·²ç»æŠ•å‡ºå»äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•ç»Ÿè®¡æŠ•ç¥¨ä¿¡æ¯ï¼Œä»¥åŠæŠ•ç¥¨é€šè¿‡åå¦‚ä½•ç”Ÿæ•ˆã€‚è¿™äº›åŠŸèƒ½éƒ½æ˜¯åœ¨`Snapshot.apply`æ–¹æ³•ä¸­å®ç°çš„ï¼š
```go
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
  for _, header := range headers {
    number := header.Number.Uint64()

    //å¦‚æœè¾¾åˆ°ä¸€ä¸ªepochï¼Œåˆ™æ¸…ç©ºå½“å‰æ‰€æœ‰çš„æŠ•ç¥¨ä¿¡æ¯
    if number%s.config.Epoch == 0 {
      snap.Votes = nil
      snap.Tally = make(map[common.Address]Tally)
    }

    //å¦‚æœå½“å‰çš„æŠ•ç¥¨äººå·²ç»ç»™æŸäººæŠ•è¿‡ç¥¨ï¼Œåˆ™æ¸…é™¤ä¹‹å‰çš„æŠ•ç¥¨ä¿¡æ¯
    //è¿™ä¿è¯äº†ä¸€ä¸ªepochå†…ä¸€ä¸ªsigneråªèƒ½ç»™æŸäººæŠ•ä¸€æ¬¡ç¥¨ï¼Œæˆ–ç”¨æ¥æ’¤æ¶ˆæŠ•ç¥¨
    for i, vote := range snap.Votes {
      if vote.Signer == signer && vote.Address == header.Coinbase {
        snap.uncast(vote.Address, vote.Authorize)
        snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
        break
      }
    }

    //å°†æœ¬æ¬¡çš„æŠ•ç¥¨ä¿¡æ¯çº³å…¥ç»Ÿè®¡
    var authorize bool
    switch {
      case bytes.Equal(header.Nonce[:], nonceAuthVote):
        authorize = true
      case bytes.Equal(header.Nonce[:], nonceDropVote):
        authorize = false
      default:
        return nil, errInvalidVote
    }
    if snap.cast(header.Coinbase, authorize) {
      snap.Votes = append(snap.Votes, &Vote{
        Signer:    signer,
        Block:     number,
        Address:   header.Coinbase,
        Authorize: authorize,
        })
    }

    //å¦‚æœæŠ•ç¥¨æ•°é‡è¶…è¿‡ä¸€åŠï¼Œåˆ™æŠ•ç¥¨é€šè¿‡ã€‚
    if tally := snap.Tally[header.Coinbase]; tally.Votes > len(snap.Signers)/2 {
      //å¦‚æœæ˜¯åŠ å…¥ç¥¨ï¼Œåˆ™å°†è¢«æŠ•äººåŠ å…¥åˆ°Signersåˆ—è¡¨ä¸­
      //ä¹‹åæ­¤äººå°±å¯ä»¥å‡ºå—äº†
      if tally.Authorize {
        snap.Signers[header.Coinbase] = struct{}{}
      } else {
        //å¦‚æœæ˜¯è¸¢å‡ºç¥¨ï¼Œåˆ™å°†è¢«æŠ•äººä»Signersåˆ—è¡¨ä¸­è¸¢å‡º
        //ä¹‹åè¿™äººå°±æ— æ³•å‡ºå—äº†
        delete(snap.Signers, header.Coinbase)

        //å°†è¢«æŠ•äººä»Recentsä¿¡æ¯ä¸­åˆ é™¤
        if limit := uint64(len(snap.Signers)/2 + 1); number >= limit {
          delete(snap.Recents, number-limit)
        }

        //ä¸¢å¼ƒè¢«æŠ•äººä¹‹å‰æŠ•å‡ºçš„æ‰€æœ‰æŠ•ç¥¨
        for i := 0; i < len(snap.Votes); i++ {
          if snap.Votes[i].Signer == header.Coinbase {
            snap.uncast(snap.Votes[i].Address, snap.Votes[i].Authorize)
            snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
            i--
          }
        }
      }

      //æ¸…é™¤æ‰€æœ‰è¢«æŠ•äººæ˜¯å½“å‰ç”Ÿæ•ˆäººçš„æŠ•ç¥¨ä¿¡æ¯
      for i := 0; i < len(snap.Votes); i++ {
        if snap.Votes[i].Address == header.Coinbase {
          snap.Votes = append(snap.Votes[:i], snap.Votes[i+1:]...)
          i--
        }
      }
      delete(snap.Tally, header.Coinbase) //æ¸…ç©ºå½“å‰ç”Ÿæ•ˆäººçš„ç¥¨æ•°ç»Ÿè®¡ä¿¡æ¯
    }
  }
}
```

è¿™æ®µä»£ç æ¯”è¾ƒå¤æ‚ï¼Œä½†é€šè¿‡ä»£ç ä¸­çš„ä¸­æ–‡æ³¨é‡Šï¼Œç›¸ä¿¡å¯ä»¥å¾ˆå®¹æ˜“å¼„æ˜ç™½å…¶åŸºæœ¬é€»è¾‘ï¼šå½“æˆ‘ä»¬é€ä¸ªéå†é“¾ä¸Šçš„blockæ—¶ï¼Œæˆ‘ä»¬è®°å½•æ¯ä¸ªblockä¸Šçš„æŠ•ç¥¨ä¿¡æ¯ï¼Œå½“æŠ•ç¥¨æ€»æ•°è¾¾åˆ°åŠæ•°ä»¥ä¸Šæ—¶ï¼Œå¯¹è¢«æŠ•äººä½œç›¸åº”çš„æ“ä½œ------åŠ å…¥æˆ–è¸¢é™¤ï¼ˆè¸¢é™¤åŒ…å«äº†æ›´å¤šæ“ä½œï¼‰ï¼›å¦‚æœé‡åˆ°epochï¼Œåˆ™ä¹‹å‰ç»Ÿè®¡çš„æ‰€æœ‰æŠ•ç¥¨ä¿¡æ¯ä½œåºŸï¼Œå…¨éƒ¨æ¸…ç©ºï¼ˆè¿™åœ¨epochæ¦‚å¿µä¸­æœ‰è¯¦ç»†è®¨è®ºï¼‰ã€‚


### ä½œæ¶çš„ä»£ä»·å’Œå¤„ç†
PoAæœºåˆ¶æ— æ³•ä¿è¯æ‰€æœ‰ç­¾åè€…éƒ½ä¸ä½œæ¶ã€‚é‚£ä¹ˆä¸‡ä¸€æœ‰äººä½œæ¶ï¼Œä¼šé€ æˆä»€ä¹ˆå½±å“å‘¢ï¼Ÿ

ç›¸ä¿¡ç»è¿‡å‰é¢ä¸æ–­çš„ä»‹ç»ï¼Œè¯»è€…å·²ç»èƒ½ç†è§£cliqueçš„åŸºæœ¬åŸç†ã€‚ç­¾åè€…åœ¨cliqueä¸­æ— æ³•è¿ç»­å‡ºå—ï¼ˆRecentæœºåˆ¶é™åˆ¶ï¼‰ï¼Œå› æ­¤å¦‚æœæœ‰äººä½œæ¶ï¼Œå®ƒæœ€å¤šä¹Ÿåªèƒ½æ¯éš”â€œå‡ºå—äººæ•°é‡ä¸€åŠâ€çš„é«˜åº¦å‡ºä¸€ä¸ªå—ï¼Œè¿™å¯ä»¥ä¿è¯å¤šæ•°å—æ˜¯æ­£ç¡®çš„ï¼Œè¿™ä¸€ç‚¹ä¸PoWç±»ä¼¼ï¼ˆåªè¦ä½œæ¶è€…çš„èƒ½åŠ›ï¼ˆå¯¹äºPoAæ¥è¯´æ˜¯ä½œæ¶çš„äººçš„æ•°é‡ï¼Œå¯¹äºPoWæ¥è¯´æ˜¯ç®—åŠ›ï¼‰ä¸è¶…è¿‡ä¸€åŠï¼Œå°±å¯ä»¥ä¿è¯å¤šæ•°å—æ˜¯æ­£å¸¸çš„ï¼‰ã€‚

cliqueæœ‰æŠ•ç¥¨æœºåˆ¶ï¼Œå¦‚æœåŠæ—¶å‘ç°æŸäººä½œæ¶ï¼Œå…¶ä»–ç­¾åè€…å¯ä»¥å¿«é€Ÿååº”ï¼Œå°†å…¶å¼ºåˆ¶è¸¢å‡ºç­¾åè€…åˆ—è¡¨ã€‚æ‰€ä»¥æ€»å¾—æ¥è¯´ï¼Œcliqueçš„å®ç°å¯ä»¥ä¿è¯å°‘é‡äººä½œæ¶çš„æƒ…å†µä¸‹åªèƒ½é€ æˆå¾ˆå°çš„å½±å“ï¼Œå¹¶ä¸”å¯ä»¥åŠæ—¶å¼ºåˆ¶åˆ¶æ­¢ã€‚

<a id="odd_if" />
### å¥‡æ€ªçš„åˆ¤æ–­æ¡ä»¶
è¿˜è®°å¾—åœ¨å‰é¢çš„åˆ†æSnapshotæ—¶ï¼Œæˆ‘ä»¬åœ¨`Clique.snapshot`æ–¹æ³•ä¸­é‡åˆ°äº†ä¸€ä¸ªå¥‡æ€ªçš„åˆ¤æ–­æ¡ä»¶å—ï¼Ÿ
```go
  if number == 0 || (number%c.config.Epoch == 0 && chain.GetHeaderByNumber(number-1) == nil) {
    æ–°ç”Ÿæˆä¸€ä¸ªSnapshotå¯¹è±¡
  }
```

`Clique.snapshot`æ˜¯ç”¨æ¥åˆ›å»ºSnapshotå¯¹è±¡çš„ï¼Œæœ‰ä¸‰ç§æƒ…å†µå¯ä»¥åˆ›å»ºï¼šè¦åˆ›å»ºçš„Snapshotåœ¨ç¼“å­˜ä¸­ï¼Œæˆ–è€…åœ¨æ•°æ®åº“ä¸­ï¼Œæˆ–è€…æ»¡è¶³ä¸Šé¢çš„åˆ¤æ–­æ¡ä»¶ã€‚

è¿™ä¸ªåˆ¤æ–­æ¡ä»¶ä»è¯­æ³•ä¸Šæ¥è¯´ä¸ç®—å¤æ‚ï¼Œå®ƒè¦è¡¨è¾¾çš„æ„æ€æ˜¯ï¼šå¦‚æœå½“å‰æ˜¯ä¸€ä¸ªåˆ›ä¸–å—æˆ–æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çˆ¶å—çš„checkpointï¼ˆnumberæ˜¯epochçš„æ•´æ•°å€ï¼‰ï¼Œåˆ™è¿›è¡ŒSnapshotçš„åˆ›å»ºã€‚

åˆ›ä¸–å—çš„åˆ¤æ–­æˆ‘èƒ½ç†è§£ï¼Œä½†ä¸ºä»€ä¹ˆéå¾—æ˜¯ä¸å­˜åœ¨çˆ¶å—çš„checkpointæ‰èƒ½åˆ›å»ºå‘¢ï¼Ÿ

å…¶å®è¿™ä¸ªåœ°æ–¹çš„ifè¯­å¥æœ€å¼€å§‹ä¸æ˜¯è¿™æ ·å†™çš„ã€‚ä»githubä¸Šclique.goæ–‡ä»¶æœ€æ—©çš„æäº¤è®°å½•ï¼ˆcommit id [feeccdf4ec1084b38dac112ff4f86809efd7c0e5](https://github.com/ethereum/go-ethereum/commit/feeccdf4ec1084b38dac112ff4f86809efd7c0e5#diff-f3a3b461458aa6a0718cad17e056c5c4R373)ï¼‰ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæœ€åˆçš„ä»£ç æ˜¯è¿™æ ·å­çš„ï¼ˆçº¿ä¸Šä»£ç åœ¨[è¿™é‡Œ](https://github.com/ethereum/go-ethereum/blob/feeccdf4ec1084b38dac112ff4f86809efd7c0e5/consensus/clique/clique.go#L373)ï¼‰ï¼š
```go
  if number == 0 {
    æ–°ç”Ÿæˆä¸€ä¸ªSnapshotå¯¹è±¡
  }
```

æœ€åˆåªæœ‰åˆ›ä¸–å—æ‰è¿›å…¥åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚è¿™å¯¼è‡´å¦‚æœä½ çš„å—éƒ½æ˜¯ä»åˆ«çš„èŠ‚ç‚¹åŒæ­¥è¿‡æ¥çš„ï¼ˆå› è€Œç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰Snapshotè¢«ä¿å­˜è¿‡ï¼‰ï¼Œé‚£ä¹ˆæƒ³è¦åœ¨æŸä¸ªé«˜åº¦ä¸Šåˆ›å»ºä¸€ä¸ªSnapshotï¼Œå°±è¦æŠŠæ‰€æœ‰åŒºå—ä»å¤´åˆ°å°¾éƒ½éå†ä¸€éã€‚

åæ¥åœ¨ä¸ºcliqueæ¨¡å—å¡«åŠ è½»å®¢æˆ·ç«¯åŒæ­¥æ”¯æŒçš„æ—¶å€™ï¼Œä½œè€…å¸Œæœ›åˆ›å»ºSnapshotçš„æ—¶å€™ä¸éœ€è¦ä»å¤´åˆ°å°¾å°†æ‰€æœ‰å—éå†ä¸€éå»åˆ›å»ºï¼Œè€Œæ˜¯ç›´æ¥ä¿¡ä»»æŸä¸ªcheckpointï¼Œä»è¿™ä¸ªcheckpointåˆ›å»ºå°±å¯ä»¥äº†ï¼Œå°±åƒä¿¡ä»»genesisä¸€æ ·ï¼Œå› æ­¤æ”¹æˆäº†è¿™æ ·ï¼ˆcommit id [9f036647e4b3e7c3aa8941dc239f85326a5e5ecd](https://github.com/ethereum/go-ethereum/commit/9f036647e4b3e7c3aa8941dc239f85326a5e5ecd#diff-f3a3b461458aa6a0718cad17e056c5c4R391)ï¼Œçº¿ä¸Šä»£ç åœ¨[è¿™é‡Œ](https://github.com/ethereum/go-ethereum/blob/9f036647e4b3e7c3aa8941dc239f85326a5e5ecd/consensus/clique/clique.go#L391)ï¼‰ï¼š
```go
  if number%c.config.Epoch == 0 {
    æ–°ç”Ÿæˆä¸€ä¸ªSnapshotå¯¹è±¡
  }
```

ä½†è¿™æ ·ä¿®æ”¹ä»¥åå‡ºç°äº†é—®é¢˜ï¼šå¦‚æœä»æŸä¸ªcheckpointç›´æ¥åˆ›å»ºSnapshotï¼Œé‚£ä¹ˆRecentså­—æ®µæ˜¯ç©ºçš„ï¼Œä½†å®é™…æƒ…å†µæ˜¯è¿™ä¸ªcheckpointå‰é¢è‚¯å®šæ˜¯æœ‰æœ€è¿‘å‡ºè¿‡å—çš„äººï¼ˆå³RecentsæŒ‰é“ç†è‚¯å®šä¸ä¸ºç©ºã€‚è¿™ä¸åˆ›ä¸–å—ä¸åŒï¼Œåˆ›ä¸–å—å‰é¢ç¡®å®æ²¡æœ‰å‡ºè¿‡å—çš„äººï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç§æƒ…å†µä¸‹æ‰€æœ‰çš„ç­¾åè€…éƒ½å¯èƒ½åˆ›å»ºä¸€ä¸ªå—ï¼Œå¹¶æˆåŠŸåŠ å…¥åˆ°é“¾ä¸­ï¼Œä½†å¾ˆå¯èƒ½è¿™ä¸ªç­¾åè€…åˆšåˆšå·²ç»åˆ›å»ºè¿‡ä¸€ä¸ªå—ã€‚è¿™è¿åäº†cliqueçš„åŸå§‹è®¾è®¡ï¼ˆä½œè€…é’ˆé’ˆå¯¹è¿™ä¸ªé—®é¢˜çš„è¯´æ˜åœ¨[è¿™é‡Œ](https://github.com/ethereum/go-ethereum/pull/17620)ï¼‰ã€‚åœ¨æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ä»¥åï¼Œä½œè€…æ›´åŠ ä¸¥æ ¼çš„é™åˆ¶äº†å¯¹checkpointçš„ä¿¡ä»»ï¼šåªæœ‰ä»åŒºå—é“¾çš„ä¸­é—´æŸä¸ªä½ç½®åŒæ­¥åŒºå—æ—¶ï¼ˆè¿™ç§æƒ…å†µä¸‹å°±å¯èƒ½ä¼šç¼ºå¤±çˆ¶å—ï¼‰ï¼Œæ‰ä½¿ç”¨è¿™ä¸ªcheckpointåˆ›å»ºSnapshotï¼Œå¦åˆ™ä¾ç„¶éå†æ•´ä¸ªé“¾æ¡åˆ›å»ºSnapshotã€‚æ‰€ä»¥ä»£ç åˆæ”¹æˆäº†ç°åœ¨çš„æ ·å­ï¼ˆcommit id [bcfb7f58b93e6fb5f3da0000672adee80fd6a485](https://github.com/ethereum/go-ethereum/commit/bcfb7f58b93e6fb5f3da0000672adee80fd6a485#diff-f3a3b461458aa6a0718cad17e056c5c4R391)ï¼Œçº¿ä¸Šä»£ç åœ¨[è¿™é‡Œ](https://github.com/ethereum/go-ethereum/blob/bcfb7f58b93e6fb5f3da0000672adee80fd6a485/consensus/clique/clique.go#L391)ï¼‰ï¼š
```go
  if number == 0 || (number%c.config.Epoch == 0 && chain.GetHeaderByNumber(number-1) == nil) {
    æ–°ç”Ÿæˆä¸€ä¸ªSnapshotå¯¹è±¡
  }
```

ç»è¿‡å¯¹æ”¹åŠ¨è¿‡ç¨‹çš„åˆ†æå’Œä½œè€…å¯¹é—®é¢˜çš„è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé—®é¢˜ä¸»è¦å‡ºå¯¹åŒºå—åŒæ­¥çš„æ”¯æŒä¸Šã€‚å¦‚æœä¸æ˜¯å¿½ç„¶åŒæ­¥å¤§é‡åŒºå—ï¼Œé‚£ä¹ˆåœ¨ç¼“å­˜æˆ–æ•°æ®åº“ä¸­è‚¯å®šå­˜åœ¨æœ€è¿‘åˆ›å»ºçš„Snapshotï¼Œæ— éœ€éå†åˆ°åˆ›ä¸–å—å°±å¯ä»¥åˆ›å»ºSnapshotï¼›ä½†ä¸ºäº†æ”¯æŒåªåŒæ­¥éƒ¨åˆ†åŒºå—ï¼ˆå¦‚ä»åŒºå—çš„ä¸­é—´æŸä¸ªcheckpointå¼€å§‹åŒæ­¥ï¼‰ï¼Œå°±éœ€è¦å¯ä»¥ä»ä»»æ„ä¸€ä¸ªcheckpointä¸ºåŸºç¡€åˆ›å»ºSnapshotã€‚åœ¨æƒè¡¡ä¹‹åï¼Œåˆ™åªå…è®¸ä»æ²¡æœ‰çˆ¶å—çš„checkpointä¸ºåŸºç¡€åˆ›å»ºSnapshotï¼Œå¯¹äºå…¶å®ƒcheckpointä»ç„¶éœ€è¦å‘å‰æŸ¥æ‰¾çˆ¶å—ã€‚

ï¼ˆè¿™ä¸ªæ”¹åŠ¨è¿›ç¨‹äº§ç”Ÿäº†bugï¼Œæœ‰äººä½¿ç”¨ç¨æ—§çš„ç‰ˆæœ¬äº§ç”ŸåŒºå—ä»¥åï¼Œä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬è¿›è¡ŒåŒæ­¥ï¼Œäº§ç”Ÿäº†é”™è¯¯ã€‚è¯¦è§[è¿™é‡Œ](https://github.com/ethereum/go-ethereum/issues/17849)ï¼‰


# æ€»ç»“
ä»¥å¤ªåŠä¸­cliqueæ¨¡å—ä½œä¸ºPoAçš„ä¸€ä¸ªå®ç°ï¼Œç›®å‰åœ¨å®˜æ–¹åº”ç”¨ä¸Šåªç”¨äº[æµ‹è¯•ç½‘ç»œ](https://faucet.rinkeby.io/)ï¼Œä½†æˆ‘ä»¬è‡ªå·±åˆ›å»ºç§äººç½‘ç»œæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚æœ¬ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†æäº†cliqueä»£ç ä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µå’Œä¸PoAç›¸å…³çš„ä¸€äº›å…³é”®é—®é¢˜ï¼Œå¹¶æç»˜äº†ä¸€ä¸ªå¤§ä½“çš„å‡ºå—æµç¨‹ã€‚

cliqueçš„ä»£ç è™½ç„¶è¾ƒå°‘ï¼Œä½†å…±è¯†æ˜¯åŒºå—é“¾é¡¹ç›®çš„æ ¸å¿ƒä¹‹ä¸€ï¼Œå› æ­¤æˆ‘åœ¨æ–‡ç« ä¸­å°½é‡è¯¦ç»†çš„å¯¹ä»£ç å’ŒåŸç†è¿›è¡Œäº†è¯´æ˜ï¼Œæœ‰äº›åœ°æ–¹ç”šè‡³å®æ„¿æœ‰é‡å¤ã€‚æ–‡ç« è‹¥æœ‰å¤±è¯¯å’Œæˆ‘ç†è§£é”™è¯¯çš„åœ°æ–¹ï¼Œè¿˜æœ›è¯»è€…ä¸åæŒ‡æ­£ã€‚
